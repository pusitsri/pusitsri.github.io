<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alice in AI Land: Game (A-F Groups)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Theme: Black, Orange, White */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Gray/Black background */
        }
        .container {
            max-width: 1200px;
        }
        /* Custom Orange Scrollbar for better theme integration */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #f97316; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: #374151; }
        /* Utility for simulating page switch */
        .page-hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8 relative"> <!-- Added relative for admin toggle positioning -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-orange-500">Alice in AI Land: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</h1>
            <!-- Subtitle is used for Landing Page text -->
            <p id="header-subtitle" class="text-lg text-gray-400 mt-2">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏°</p>
            
            <!-- Total Voter Count Display for Game Page (Hidden by default, positioned in header) -->
            <div id="game-voter-summary" class="text-lg text-gray-300 mt-2 hidden">
                <span class="text-xl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span> 
                <span id="voter-count-header" class="text-2xl font-bold ml-2 text-orange-400">0</span> 
                <span>‡∏Ñ‡∏ô</span>
            </div>
        </header>

        <!-- ============================================== -->
        <!-- STEP 1: LANDING/AUTH PAGE -->
        <!-- ============================================== -->
        <div class="relative max-w-4xl mx-auto">
            <!-- Admin Toggle Link (New Element: Positioned top-left) -->
            <button id="admin-toggle-link" class="absolute top-[-1.5rem] left-4 text-sm text-gray-400 hover:text-orange-500 transition duration-200">
                üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin
            </button>
            <!-- Error message will now be shown via dialog, this is just for visual space -->
            <p id="guest-access-error" class="absolute top-[-1.5rem] right-4 text-sm text-red-500 font-medium hidden"></p> 

            <!-- Landing Page Grid -->
            <div id="landing-page" class="grid grid-cols-1 md:grid-cols-3 gap-8 page-hidden">
                
                <!-- Admin Login (Initially Hidden, Toggle by Link) -->
                <div id="landing-admin-card" class="bg-white p-6 rounded-xl shadow-2xl border-4 border-gray-300 hidden">
                    <h2 class="text-2xl font-bold mb-4 text-orange-600 border-b pb-3">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin
                    </h2>
                    <form id="admin-login-form">
                        <label for="admin-passcode-input" class="block text-sm font-medium text-gray-700 mb-2">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ Admin 4 ‡∏´‡∏•‡∏±‡∏Å</label>
                        <input type="password" id="admin-passcode-input" required maxlength="4" placeholder="****"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150 text-center text-xl font-mono text-gray-900">
                        <button type="submit" id="landing-admin-btn"
                            class="w-full mt-4 bg-gray-500 text-white p-3 rounded-lg font-semibold hover:bg-gray-600 transition duration-200 shadow-md">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin
                        </button>
                    </form>
                    <p id="admin-login-message" class="mt-3 text-sm text-red-600 font-medium text-center"></p>
                    <p id="block-message-landing" class="text-center p-3 rounded-lg font-bold text-lg bg-red-100 text-red-700 hidden mt-4">
                        üö´ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£
                    </p>
                </div>

                <!-- Player Registration / Resume Card -->
                <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-300 col-span-1 md:col-span-1" id="player-card"> 
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-3">
                        ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
                    </h2>
                    
                    <!-- Content for NEW Player (Default) -->
                    <div id="player-card-content"> 
                        <form id="player-registration-form">
                            <label for="player-name-input" class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</label>
                            <input type="text" id="player-name-input" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150 text-gray-900">
                            <button type="submit"
                                class="w-full mt-4 bg-orange-500 text-white p-3 rounded-lg font-semibold hover:bg-orange-600 transition duration-200 shadow-md">
                                ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°
                            </button>
                        </form>
                    </div>

                    <!-- Content for RETURNING Player (Hidden by default, shown via JS) -->
                    <div id="player-resume-content" class="hidden">
                        <p class="text-lg text-gray-700 mb-4">
                            ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤, <span id="resumed-player-name" class="font-bold text-orange-600"></span>!
                        </p>
                        <button id="resume-player-button" class="w-full mt-2 bg-orange-500 text-white p-3 rounded-lg font-semibold hover:bg-orange-600 transition duration-200 shadow-md">
                            ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ
                        </button>
                        <button id="resume-as-guest-button" class="w-full mt-3 bg-gray-200 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 shadow-md border border-gray-400">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Guest Mode)
                        </button>
                        <button id="change-name-button" class="w-full mt-3 text-sm text-gray-500 hover:text-red-500 transition duration-200">
                            ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>

                    <p class="text-sm text-gray-500 mt-3 text-center">
                        (‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
                    </p>
                </div>

                <!-- Guest Access -->
                <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-300 flex flex-col justify-between col-span-1 md:col-span-1">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-3">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                        </h2>
                        <p class="text-gray-600 mb-4">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ (‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
                        </p>
                    </div>
                    <button id="guest-access-button"
                        class="w-full bg-gray-200 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 shadow-md border border-gray-400">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏° (Guest)
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- STEP 2: GAME PAGE -->
        <!-- ============================================== -->
        <div id="game-page" class="grid grid-cols-1 lg:grid-cols-3 gap-10 page-hidden">
            
            <!-- Game Control, Timer & Player/Guest Area -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- GLOBAL TIMER DISPLAY (Visible to all when game is RUNNING) -->
                <div id="timer-display" class="bg-white p-4 rounded-xl shadow-2xl border border-gray-300 text-center hidden">
                    <p class="text-xl font-semibold text-gray-800 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</p>
                    <span id="timer-value" class="text-6xl font-extrabold text-orange-600">00:00</span>
                </div>

                <!-- Admin Control Panel (Visible only to Admin) -->
                <div id="admin-control-panel" class="bg-white p-6 rounded-xl shadow-2xl border-4 border-orange-500 hidden">
                    <h2 class="text-2xl font-bold mb-4 text-orange-600 border-b pb-3">
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Å‡∏°
                    </h2>
                    <div id="game-status-display" class="mb-4 text-center p-3 rounded-lg font-bold text-lg">
                        <p id="status-text" class="text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>
                    </div>
                    
                    <!-- Timer Adjustments -->
                    <div class="mb-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</h3>
                        <div class="flex justify-between items-center space-x-2">
                            <button id="time-minus-btn" disabled 
                                class="w-1/2 bg-gray-600 text-white p-2 rounded-lg font-semibold hover:bg-gray-700 transition duration-200 disabled:opacity-50">
                                - 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                            </button>
                            <button id="time-plus-btn" disabled 
                                class="w-1/2 bg-gray-600 text-white p-2 rounded-lg font-semibold hover:bg-gray-700 transition duration-200 disabled:opacity-50">
                                + 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                            </button>
                        </div>
                    </div>


                    <!-- Main Control Buttons -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button id="main-control-button" disabled
                            class="col-span-1 bg-orange-500 text-white p-3 rounded-lg font-semibold hover:bg-orange-600 transition duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                        </button>
                        <button id="terminate-button" disabled
                            class="col-span-1 bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        </button>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-2 text-center">
                        *Admin ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ
                    </p>
                    <button id="logout-admin-button"
                        class="w-full mt-4 bg-gray-400 text-gray-800 p-2 rounded-lg font-semibold hover:bg-gray-500 transition duration-200 shadow-md">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin
                    </button>
                </div>
                
                <!-- Player Info and Message (NEW SECTION) -->
                <div id="player-info-section" class="bg-white p-6 rounded-xl shadow-2xl h-fit border border-gray-300 hidden">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>
                    
                    <p id="player-name-display" class="text-lg font-semibold text-gray-700 mb-4">
                        ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: <span id="current-player-name" class="text-orange-600"></span>
                    </p>

                    <div id="vote-message-container">
                        <p id="vote-message" class="mt-4 text-center text-red-600 font-semibold hidden">
                            <!-- Success/Error message will appear here -->
                        </p>
                    </div>
                    
                    <!-- LOGOUT BUTTON FOR PLAYER -->
                    <button id="logout-player-button" 
                        class="w-full mt-4 bg-gray-200 text-gray-700 p-2 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 shadow-md border border-gray-400">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)
                    </button>
                </div>

                <!-- Guest/Blocked Message Area (Visible to Guests or Blocked Users) -->
                <div id="guest-view-section" class="bg-white p-6 rounded-xl shadow-2xl h-fit border border-gray-300 hidden">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏ä‡∏° (Guest View)</h2>
                    <p class="text-gray-600 mb-4">‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ</p>
                    <p id="guest-block-message" class="text-center p-3 rounded-lg font-bold text-lg bg-red-100 text-red-700 hidden">
                        üö´ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£
                    </p>
                    <button id="logout-guest-button"
                        class="w-full mt-4 bg-gray-200 text-gray-700 p-2 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 shadow-md border border-gray-400">
                        ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                    </button>
                </div>
            </div>

            <!-- Results Section (Visible to all roles) -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-2xl border border-gray-300">
                <!-- MODIFIED TITLE -->
                <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå)</h2>
                
                <div id="results-container" class="space-y-6">
                    <p id="loading-message" class="text-center text-gray-500">
                        <svg class="animate-spin h-5 w-5 mr-3 inline text-orange-500" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°...
                    </p>
                </div>
            </div>
        </div>

    </div>
    
    <!-- Custom Alert Dialog (Hidden by Default) -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-xl max-w-sm w-full shadow-2xl border-4 border-red-500">
            <h3 class="text-2xl font-bold text-red-600 mb-4">üõë ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
            <p id="custom-alert-message" class="text-gray-700 mb-6"></p>
            <button id="custom-alert-close-btn" class="w-full bg-red-500 text-white p-3 rounded-lg font-semibold hover:bg-red-600 transition duration-200 shadow-lg">
                ‡∏ï‡∏Å‡∏•‡∏á
            </button>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, getDoc, setLogLevel, deleteDoc, getDocs, updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const ADMIN_PASSCODE = '7793';
        const MAX_LOGIN_ATTEMPTS = 3;
        const DEFAULT_DURATION_SECONDS = 120; // 2 ‡∏ô‡∏≤‡∏ó‡∏µ
        // Game state now uses three status: IDLE, RUNNING, PAUSED
        let gameState = { status: 'IDLE', endTime: null, remainingTimeSeconds: DEFAULT_DURATION_SECONDS, newGameTimestamp: null };
        let timerInterval = null;
        const GROUP_LABELS = ['A', 'B', 'C', 'D', 'E', 'F'];
        let hasSubmittedInitialVote = false; 

        // *** ROLE STATES ***
        let currentUserRole = 'Unknown'; // 'Admin', 'Player', 'Guest', 'Unknown'
        let isAdmin = false; 
        let isPlayer = false;
        let isGuest = false;
        let playerName = '';

        // *** FIREBASE CONFIGURATION ***
        const customFirebaseConfig = {
            apiKey: "AIzaSyDOrTeFqzQJNtz0bR327Z7HiM3F4pjxKyA",
            authDomain: "alice-game-b2aa5.firebaseapp.com",
            projectId: "alice-game-b2aa5",
            storageBucket: "alice-game-b2aa5.firebasestorage.app",
            messagingSenderId: "70768832876",
            appId: "1:70768832876:web:e3d908f7b1a9f1d1458349"
        };
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : customFirebaseConfig; 
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        let db;
        let auth;
        let userId = null;
        
        // Admin Security State
        let isUserBlocked = false;
        let loginAttempts = 0;

        // --- ELEMENTS ---
        const headerSubtitle = document.getElementById('header-subtitle');
        const landingPage = document.getElementById('landing-page');
        const gamePage = document.getElementById('game-page');
        
        // Landing Page Elements
        const adminToggleLink = document.getElementById('admin-toggle-link');
        const landingAdminCard = document.getElementById('landing-admin-card');
        const adminLoginForm = document.getElementById('admin-login-form');
        const playerRegistrationForm = document.getElementById('player-registration-form');
        const playerCardContentEl = document.getElementById('player-card-content');
        const playerResumeContentEl = document.getElementById('player-resume-content');
        const resumePlayerButton = document.getElementById('resume-player-button');
        const resumeAsGuestButton = document.getElementById('resume-as-guest-button');
        const changeNameButton = document.getElementById('change-name-button');
        const resumedPlayerNameEl = document.getElementById('resumed-player-name');

        const guestAccessButton = document.getElementById('guest-access-button');
        const adminLoginMessageEl = document.getElementById('admin-login-message');
        const adminPasscodeInput = document.getElementById('admin-passcode-input');
        const playerNameInput = document.getElementById('player-name-input');
        const blockMessageLandingEl = document.getElementById('block-message-landing');
        const guestAccessErrorEl = document.getElementById('guest-access-error'); 
        
        // Custom Alert Dialog Elements
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessageEl = document.getElementById('custom-alert-message');
        const customAlertCloseBtn = document.getElementById('custom-alert-close-btn');

        // Game Page Elements
        const adminControlPanel = document.getElementById('admin-control-panel');
        const playerInfoSection = document.getElementById('player-info-section'); // MODIFIED
        const guestViewSection = document.getElementById('guest-view-section');
        const currentPlayerNameEl = document.getElementById('current-player-name');
        const logoutAdminButton = document.getElementById('logout-admin-button');
        const logoutGuestButton = document.getElementById('logout-guest-button');
        const logoutPlayerButton = document.getElementById('logout-player-button');
        const gameVoterSummaryEl = document.getElementById('game-voter-summary');
        const voterCountHeaderEl = document.getElementById('voter-count-header');

        // Admin Control Elements 
        const mainControlButton = document.getElementById('main-control-button');
        const terminateButton = document.getElementById('terminate-button');
        const timePlusBtn = document.getElementById('time-plus-btn');
        const timeMinusBtn = document.getElementById('time-minus-btn');

        const voteMessage = document.getElementById('vote-message'); // Moved to player-info-section
        const resultsContainer = document.getElementById('results-container');
        const loadingMessage = document.getElementById('loading-message');
        const authStatusEl = document.getElementById('auth-status');
        const statusTextEl = document.getElementById('status-text');
        const timerDisplayEl = document.getElementById('timer-display'); 
        const timerValueEl = document.getElementById('timer-value'); 
        
        // Firestore path
        const GAME_STATE_DOC_PATH = `artifacts/${appId}/public/data/gameState`;
        const VOTES_COLLECTION_PATH = `artifacts/${appId}/public/data/votes`;
        const BLOCK_STATUS_DOC_PATH = (uid) => `artifacts/${appId}/users/${uid}/status/adminBlock`;

        // Set Firebase log level for debugging
        setLogLevel('Debug');

        // --- UTILITY FUNCTIONS ---

        function showCustomAlert(message) {
            customAlertMessageEl.textContent = message;
            customAlertModal.classList.remove('hidden');
        }

        function hideCustomAlert() {
            customAlertModal.classList.add('hidden');
        }
        
        function showPage(pageId) {
            landingPage.classList.add('page-hidden');
            gamePage.classList.add('page-hidden');
            
            if (pageId === 'landing') {
                landingPage.classList.remove('page-hidden');
                headerSubtitle.classList.remove('hidden');
                gameVoterSummaryEl.classList.add('hidden'); // Hide game summary
                headerSubtitle.textContent = '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏°';
                adminLoginMessageEl.classList.add('hidden'); 
                guestAccessErrorEl.classList.add('hidden'); 
                renderLandingPageUI(); 
                
            } else if (pageId === 'game') {
                gamePage.classList.remove('page-hidden');
                headerSubtitle.classList.add('hidden'); // Hide landing subtitle
                gameVoterSummaryEl.classList.remove('hidden'); // Show game summary
            }
        }
        
        function renderLandingPageUI() {
            const storedName = sessionStorage.getItem('playerName');
            
            // Set default grid layout
            landingPage.classList.remove('md:grid-cols-3');
            landingPage.classList.add('md:grid-cols-2', 'md:max-w-xl');
            document.getElementById('player-card').classList.add('md:col-span-1');
            landingAdminCard.classList.add('hidden');
            
            if (storedName && !playerNameInput.dataset.forceRegister) {
                // Show resume options
                playerCardContentEl.classList.add('hidden');
                playerResumeContentEl.classList.remove('hidden');
                resumedPlayerNameEl.textContent = storedName;
            } else {
                // Show fresh registration form
                playerCardContentEl.classList.remove('hidden');
                playerResumeContentEl.classList.add('hidden');
                playerNameInput.dataset.forceRegister = ''; // Clear flag
            }
        }
        
        function updateRole(role, name = '') {
            currentUserRole = role;
            isAdmin = role === 'Admin';
            isPlayer = role === 'Player';
            isGuest = role === 'Guest';
            playerName = name;
            
            // Save role to sessionStorage to maintain state across soft refreshes/navigation
            sessionStorage.setItem('currentUserRole', role);
            if (name) sessionStorage.setItem('playerName', name);
            
            renderGamePageUI();
        }

        function renderGamePageUI() {
            // Hide all role-specific elements first
            adminControlPanel.classList.add('hidden');
            playerInfoSection.classList.add('hidden');
            guestViewSection.classList.add('hidden');
            
            if (isAdmin) {
                adminControlPanel.classList.remove('hidden');
            } else if (isPlayer) {
                playerInfoSection.classList.remove('hidden');
                currentPlayerNameEl.textContent = playerName;
            } else if (isGuest) {
                guestViewSection.classList.remove('hidden');
            }
        }
        
        // --- FIREBASE INITIALIZATION & AUTH ---
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    
                    await checkBlockStatus(userId);

                    if (isUserBlocked) {
                        showPage('landing');
                        blockMessageLandingEl.classList.remove('hidden');
                        adminPasscodeInput.disabled = true;
                        document.getElementById('landing-admin-btn').disabled = true;
                        playerRegistrationForm.querySelector('input').disabled = true;
                        playerRegistrationForm.querySelector('button').disabled = true;
                        guestAccessButton.disabled = false;
                        return;
                    }

                    const savedRole = sessionStorage.getItem('currentUserRole');
                    const savedName = sessionStorage.getItem('playerName') || '';

                    if (savedRole && savedRole !== 'Unknown') {
                        updateRole(savedRole, savedName);
                        startRealtimeListeners();
                        if (savedRole === 'Guest' && gameState.status === 'IDLE') {
                            updateRole('Unknown'); 
                            showPage('landing');
                        } else {
                            showPage('game');
                        }
                    } else {
                        showPage('landing');
                    }

                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        authStatusEl.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Auth): " + error.message;
                        authStatusEl.classList.remove('hidden');
                    }
                }
            });

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            authStatusEl.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ: " + error.message;
            authStatusEl.classList.remove('hidden');
        }

        // --- ADMIN BLOCK LOGIC (PERSISTENCE) ---
        async function checkBlockStatus(uid) {
            if (!db) return;
            try {
                const blockDocRef = doc(db, BLOCK_STATUS_DOC_PATH(uid));
                const docSnap = await getDoc(blockDocRef);
                
                if (docSnap.exists() && docSnap.data().isBlocked === true) {
                    isUserBlocked = true;
                } else {
                    isUserBlocked = false;
                }
            } catch (error) {
                console.error("Error fetching block status: ", error);
            }
        }

        async function blockUser(uid) {
            if (!db) return;
            try {
                const blockDocRef = doc(db, BLOCK_STATUS_DOC_PATH(uid));
                await setDoc(blockDocRef, { isBlocked: true, timestamp: serverTimestamp() });
                isUserBlocked = true;
            } catch (error) {
                console.error("Error blocking user: ", error);
            }
        }

        // --- GAME STATE AND TIMER CONTROL ---
        function startRealtimeListeners() {
            if (!db || !userId) return;

            onSnapshot(doc(db, GAME_STATE_DOC_PATH, 'current'), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    gameState = docSnapshot.data();
                    handleGameStateChange();
                } else {
                    // Initialize game state if it doesn't exist
                    if (gameState.status === 'IDLE') {
                        setDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                            status: 'IDLE', 
                            endTime: null, 
                            remainingTimeSeconds: DEFAULT_DURATION_SECONDS,
                            newGameTimestamp: serverTimestamp()
                        }, { merge: true });
                    }
                    handleGameStateChange();
                }
            }, (error) => {
                console.error("Error fetching game state: ", error);
            });

            const votesCollectionRef = collection(db, VOTES_COLLECTION_PATH);
            const q = query(votesCollectionRef);

            onSnapshot(q, (snapshot) => {
                loadingMessage.classList.add('hidden'); 
                const allVotes = [];
                const results = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [] };
                let userDocFound = false; 
                let userCurrentVote = -1;

                snapshot.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    allVotes.push(data);
                    
                    if (data.vote !== undefined && data.vote >= 0 && data.vote <= 5 && results[data.vote]) {
                        results[data.vote].push(data.name);
                    }

                    if (docSnapshot.id === userId && isPlayer) {
                        userDocFound = true;
                        userCurrentVote = data.vote;
                    }
                });

                hasSubmittedInitialVote = userDocFound; 
                
                renderResults(allVotes.length, results, userCurrentVote); // Pass current vote
                
            }, (error) => {
                console.error("Error fetching real-time votes: ", error);
                resultsContainer.innerHTML = '<p class="text-red-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏î‡πâ: ' + error.message + '</p>';
            });
        }

        function updateAdminControls(status) {
            if (!isAdmin) return;

            terminateButton.disabled = (status === 'IDLE');
            timePlusBtn.disabled = (status === 'IDLE');
            timeMinusBtn.disabled = (status === 'IDLE');

            if (status === 'IDLE') {
                mainControlButton.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡πÄ‡∏Å‡πà‡∏≤)';
                mainControlButton.classList.remove('bg-yellow-500', 'bg-green-500');
                mainControlButton.classList.add('bg-orange-500');
            } else if (status === 'RUNNING') {
                mainControlButton.textContent = '‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (Pause)';
                mainControlButton.classList.remove('bg-orange-500', 'bg-green-500');
                mainControlButton.classList.add('bg-yellow-500');
            } else if (status === 'PAUSED') {
                mainControlButton.textContent = '‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠ (Resume)';
                mainControlButton.classList.remove('bg-orange-500', 'bg-yellow-500');
                mainControlButton.classList.add('bg-green-500');
            }
            mainControlButton.disabled = false;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function handleGameStateChange() {
            clearInterval(timerInterval); 
            timerDisplayEl.classList.add('hidden'); 
            
            const isFreshGame = gameState.status === 'IDLE' && (gameState.newGameTimestamp || 0);
            
            // Redirect players/guests if a new game reset just occurred
            if ((isPlayer || isGuest) && isFreshGame && sessionStorage.getItem('latestGameTimestamp') !== gameState.newGameTimestamp?.toMillis()) {
                if (isPlayer) {
                    sessionStorage.removeItem('currentUserRole');
                } else { 
                    sessionStorage.removeItem('currentUserRole');
                    sessionStorage.removeItem('playerName');
                }
                sessionStorage.removeItem('latestGameTimestamp');
                updateRole('Unknown');
                showPage('landing');
                return;
            }
            
            if (isFreshGame) {
                sessionStorage.setItem('latestGameTimestamp', gameState.newGameTimestamp.toMillis());
            }

            // Update Admin Controls based on new status
            updateAdminControls(gameState.status);

            // Update UI status text
            statusTextEl.textContent = 
                gameState.status === 'RUNNING' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô!' :
                gameState.status === 'PAUSED' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß' :
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏à‡∏ö‡πÄ‡∏Å‡∏° / ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°';
            statusTextEl.className = `text-center p-3 rounded-lg font-bold text-lg ${
                gameState.status === 'RUNNING' ? 'bg-red-100 text-red-600' :
                gameState.status === 'PAUSED' ? 'bg-yellow-100 text-yellow-600' :
                'bg-gray-100 text-gray-600'
            }`;

            // Handle Timer Logic
            if (gameState.status === 'RUNNING' && gameState.endTime) {
                const endTimeMs = gameState.endTime.toMillis ? gameState.endTime.toMillis() : new Date(gameState.endTime).getTime();
                let remainingTimeSeconds = Math.max(0, Math.floor((endTimeMs - Date.now()) / 1000));

                if (remainingTimeSeconds > 0) {
                    timerDisplayEl.classList.remove('hidden');
                    
                    timerInterval = setInterval(() => {
                        remainingTimeSeconds = Math.max(0, Math.floor((endTimeMs - Date.now()) / 1000));
                        timerValueEl.textContent = formatTime(remainingTimeSeconds);
                        
                        if (remainingTimeSeconds <= 0) {
                            clearInterval(timerInterval);
                            terminateGame(); // Force game to IDLE
                        }
                    }, 1000);
                } else {
                    terminateGame(); // Time ran out
                }
            } else if (gameState.status === 'PAUSED' && gameState.remainingTimeSeconds !== undefined) {
                // Show the remaining time when paused
                timerDisplayEl.classList.remove('hidden');
                timerValueEl.textContent = formatTime(gameState.remainingTimeSeconds);
            } else if (gameState.status === 'IDLE') {
                // Show default time or initial time when IDLE
                timerDisplayEl.classList.remove('hidden');
                timerValueEl.textContent = formatTime(gameState.remainingTimeSeconds || DEFAULT_DURATION_SECONDS);
                timerDisplayEl.classList.add('hidden'); // Re-hide timer display when IDLE
            }
        }

        // --- ADMIN ACTIONS ---
        // (Admin actions functions remain unchanged)
        // ... (startGame, togglePause, terminateGame, adjustTime, clearPreviousGameData) ...
        
        mainControlButton.addEventListener('click', async () => {
            if (!db || !userId || !isAdmin) return;

            if (gameState.status === 'IDLE') {
                await startGame();
            } else if (gameState.status === 'RUNNING') {
                await togglePause(true);
            } else if (gameState.status === 'PAUSED') {
                await togglePause(false);
            }
        });
        
        async function startGame() {
            if (!db || !userId || !isAdmin) return;
            mainControlButton.disabled = true;
            mainControlButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            
            try {
                await clearPreviousGameData();
                
                mainControlButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...';
                const now = Date.now();
                const endTime = new Date(now + (DEFAULT_DURATION_SECONDS * 1000));

                await setDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                    status: 'RUNNING',
                    endTime: endTime,
                    remainingTimeSeconds: DEFAULT_DURATION_SECONDS, // Initial time for the round
                    newGameTimestamp: serverTimestamp(),
                    adminId: userId 
                });

            } catch (error) {
                console.error("Error starting game: ", error);
                showCustomAlert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ: " + error.message);
            }
        }
        
        async function togglePause(pauseState) {
            if (!db || !userId || !isAdmin) return;
            
            if (pauseState) { 
                const remaining = Math.max(0, Math.floor((gameState.endTime.toMillis() - Date.now()) / 1000));

                await updateDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                    status: 'PAUSED',
                    remainingTimeSeconds: remaining,
                    endTime: null
                });

            } else { 
                const now = Date.now();
                const newEndTime = new Date(now + (gameState.remainingTimeSeconds * 1000));

                await updateDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                    status: 'RUNNING',
                    endTime: newEndTime,
                });
            }
        }

        terminateButton.addEventListener('click', async () => {
            if (!db || !userId || !isAdmin) return;
            await terminateGame();
        });

        async function terminateGame() {
            if (!db || !userId || !isAdmin) return;
            
            clearInterval(timerInterval);

            await setDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                status: 'IDLE',
                endTime: null,
                remainingTimeSeconds: DEFAULT_DURATION_SECONDS,
                activeAdminId: null 
            }, { merge: true });
        }
        
        const TIME_ADJUSTMENT = 30; // seconds
        timePlusBtn.addEventListener('click', () => adjustTime(TIME_ADJUSTMENT));
        timeMinusBtn.addEventListener('click', () => adjustTime(-TIME_ADJUSTMENT));

        async function adjustTime(seconds) {
            if (!db || !userId || !isAdmin || gameState.status === 'IDLE') return;

            const gameStateDocRef = doc(db, GAME_STATE_DOC_PATH, 'current');
            
            if (gameState.status === 'RUNNING') {
                const currentEndTimeMs = gameState.endTime.toMillis();
                const newEndTimeMs = currentEndTimeMs + (seconds * 1000);

                if (newEndTimeMs <= Date.now() && seconds < 0) {
                     await terminateGame();
                     return;
                }
                
                await updateDoc(gameStateDocRef, {
                    endTime: new Date(newEndTimeMs)
                });

            } else if (gameState.status === 'PAUSED') {
                const newRemaining = Math.max(0, gameState.remainingTimeSeconds + seconds);

                if (newRemaining <= 0) {
                     await terminateGame();
                     return;
                }

                await updateDoc(gameStateDocRef, {
                    remainingTimeSeconds: newRemaining
                });
            }
        }
        
        async function clearPreviousGameData() {
            const votesRef = collection(db, VOTES_COLLECTION_PATH);
            const snapshot = await getDocs(votesRef);
            
            const deletePromises = [];
            snapshot.forEach(doc => {
                deletePromises.push(deleteDoc(doc.ref));
            });
            
            await Promise.all(deletePromises);
            
            const gameStateDocRef = doc(db, GAME_STATE_DOC_PATH, 'current');
            await updateDoc(gameStateDocRef, { newGameTimestamp: serverTimestamp() }); 
        }

        // --- NEW: Group Selection and Submission ---
        // Global scope function accessible from inline onclick
        window.selectGroup = async function(voteValue, groupLabel) {
            if (!isPlayer || gameState.status !== 'RUNNING') {
                showCustomAlert(gameState.status === 'IDLE' ? '‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°' : '‡πÄ‡∏Å‡∏°‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß');
                return;
            }
            
            if (!userId) {
                voteMessage.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö... ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
                voteMessage.classList.remove('hidden');
                voteMessage.classList.add('text-red-600');
                return;
            }

            // Disable all buttons in the results container temporarily
            document.querySelectorAll('.vote-group-button').forEach(btn => btn.disabled = true);
            voteMessage.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...';
            voteMessage.classList.remove('hidden', 'text-green-600', 'text-red-600');

            try {
                const voteDocRef = doc(db, VOTES_COLLECTION_PATH, userId);

                await setDoc(voteDocRef, {
                    name: playerName,
                    vote: voteValue,
                    timestamp: serverTimestamp(),
                    userId: userId 
                }, { merge: true }); 

                voteMessage.textContent = `‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° ${groupLabel} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà`;
                voteMessage.classList.add('text-green-600');
                
            } catch (error) {
                console.error("Error submitting vote: ", error);
                voteMessage.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message;
                voteMessage.classList.add('text-red-600');
            }
            
            // Re-enabling is handled by onSnapshot -> renderResults call
        }

        // --- UI RENDERING (Modified) ---
        function renderResults(totalCount, results, userCurrentVote) {
            // 1. Update the total count in the header
            voterCountHeaderEl.textContent = totalCount;
            
            resultsContainer.innerHTML = ''; 
            
            // 3. Determine if voter names should be shown (only when IDLE/game ended)
            const showNames = gameState.status === 'IDLE';

            const voteCounts = Object.keys(results).map(vote => ({
                number: parseInt(vote),
                count: results[vote].length,
                names: results[vote],
                label: GROUP_LABELS[parseInt(vote)] // Include label for sorting
            }));

            // *** NEW SORTING LOGIC: Count DESC, Label ASC ***
            voteCounts.sort((a, b) => {
                if (b.count !== a.count) {
                    return b.count - a.count; // Sort by count descending
                }
                return a.label.localeCompare(b.label); // Sort by label ascending (A-F)
            });
            // *** END NEW SORTING LOGIC ***

            voteCounts.forEach(({ number, count, names, label }) => {
                const percentage = totalCount > 0 ? (count / totalCount) * 100 : 0;

                // Logic for showing/hiding names
                const namesList = names.length > 0 && showNames
                    ? `<ul class="list-disc list-inside mt-3 ml-4 space-y-1 text-gray-700 max-h-40 overflow-y-auto">
                           ${names.map(name => `<li class="text-sm">${name}</li>`).join('')}
                       </ul>`
                    : (showNames 
                        ? '<p class="text-sm italic text-gray-500 mt-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</p>'
                        : '<p class="text-sm italic text-gray-500 mt-2">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö‡πÄ‡∏Å‡∏°</p>'
                      );
                
                const voterListTitle = showNames 
                    ? `‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (${names.length} ‡∏Ñ‡∏ô):` 
                    : '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: (‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏•‡πà‡∏ô)';
                
                // Button visibility and disabled state (Dynamic in client side)
                let buttonHtml = '';
                if (isPlayer) {
                    const isRunning = gameState.status === 'RUNNING';
                    const isSelected = userCurrentVote === number;
                    const buttonText = hasSubmittedInitialVote ? 
                        (isSelected ? '‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' : '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ') : 
                        '‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ';
                    
                    const buttonClasses = isSelected && isRunning
                        ? 'bg-green-600 hover:bg-green-700'
                        : isRunning
                            ? 'bg-orange-500 hover:bg-orange-600'
                            : 'bg-gray-400';

                    buttonHtml = `
                        <div class="mt-4 pt-4 border-t border-gray-200 flex justify-end">
                            <button 
                                data-group-number="${number}"
                                onclick="selectGroup(${number}, '${label}')"
                                ${isRunning ? '' : 'disabled'}
                                class="vote-group-button ${buttonClasses} text-white p-2 px-4 rounded-lg font-semibold transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                                ${buttonText}
                            </button>
                        </div>
                    `;
                }


                const resultBlock = `
                    <div class="bg-gray-50 p-4 rounded-xl shadow-md border-l-4 border-orange-500">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold text-gray-800">
                                ‡∏Å‡∏•‡∏∏‡πà‡∏° <span class="text-orange-600">${label}</span>
                            </h3>
                            <span class="text-3xl font-extrabold text-orange-700">${count}</span>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
                            <div class="bg-orange-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô: ${percentage.toFixed(1)}%</p>
                        
                        <!-- Voter List (Visibility controlled by JS/showNames) -->
                        <div class="mt-4 pt-3 border-t border-gray-200">
                            <h4 class="font-semibold text-gray-700">${voterListTitle}</h4>
                            ${namesList}
                        </div>
                        
                        ${buttonHtml}
                    </div>
                `;
                resultsContainer.innerHTML += resultBlock;
            });
            
            // After rendering, re-enable buttons that were disabled during submission
            if (isPlayer && gameState.status === 'RUNNING') {
                document.querySelectorAll('.vote-group-button').forEach(btn => btn.disabled = false);
            }
        }
        
        // --- LOGOUT HANDLER (Shared by Player and Guest) ---
        function handlePlayerGuestLogout() {
            const roleToClear = sessionStorage.getItem('currentUserRole');
            sessionStorage.removeItem('currentUserRole');
            
            if (roleToClear === 'Guest') {
                sessionStorage.removeItem('playerName');
            }
            
            updateRole('Unknown');
            showPage('landing');
        }

        // --- EVENT LISTENERS (Landing Page) ---
        
        customAlertCloseBtn.addEventListener('click', hideCustomAlert);

        adminToggleLink.addEventListener('click', () => {
            landingAdminCard.classList.toggle('hidden');
            if (landingAdminCard.classList.contains('hidden')) {
                landingPage.classList.remove('md:grid-cols-3');
                landingPage.classList.add('md:grid-cols-2', 'md:max-w-xl');
            } else {
                landingPage.classList.add('md:grid-cols-3');
                landingPage.classList.remove('md:grid-cols-2', 'md:max-w-xl');
            }
        });

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isUserBlocked) {
                adminLoginMessageEl.textContent = 'üö´ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£!';
                return;
            }
            const passcode = adminPasscodeInput.value.trim();

            if (passcode === ADMIN_PASSCODE) {
                updateRole('Admin'); 
                showPage('game');
                startRealtimeListeners();
                
                try {
                    const gameStateDocRef = doc(db, GAME_STATE_DOC_PATH, 'current');
                    await setDoc(gameStateDocRef, { activeAdminId: userId }, { merge: true }); 
                } catch (error) {
                    console.error("Error setting activeAdminId: ", error);
                }
                
            } else {
                loginAttempts++;
                const remaining = MAX_LOGIN_ATTEMPTS - loginAttempts;

                if (remaining > 0) {
                    adminLoginMessageEl.textContent = `‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡∏µ‡∏Å ${remaining} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
                } else {
                    adminLoginMessageEl.textContent = 'üõë ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏°‡∏ñ‡∏≤‡∏ß‡∏£';
                    adminLoginForm.querySelector('input').disabled = true;
                    adminLoginForm.querySelector('button').disabled = true;
                    if (userId) {
                        await blockUser(userId);
                    }
                }
            }
            adminPasscodeInput.value = ''; 
        });

        playerRegistrationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = playerNameInput.value.trim();
            if (name) {
                sessionStorage.removeItem('playerName'); 
                
                updateRole('Player', name);
                showPage('game');
                startRealtimeListeners();
            }
        });
        
        resumePlayerButton.addEventListener('click', () => {
            const storedName = sessionStorage.getItem('playerName');
            if (storedName) {
                updateRole('Player', storedName);
                showPage('game');
                startRealtimeListeners();
            }
        });
        
        resumeAsGuestButton.addEventListener('click', async () => {
            const currentGameState = (await getDoc(doc(db, GAME_STATE_DOC_PATH, 'current'))).data();
            if (currentGameState?.status !== 'RUNNING' && currentGameState?.status !== 'PAUSED') {
                showCustomAlert('‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°! Guest ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°');
                return;
            }
            updateRole('Guest');
            showPage('game');
            startRealtimeListeners();
        });
        
        changeNameButton.addEventListener('click', () => {
            sessionStorage.removeItem('playerName');
            playerNameInput.dataset.forceRegister = 'true';
            playerNameInput.value = '';
            renderLandingPageUI(); 
        });


        guestAccessButton.addEventListener('click', async () => {
            
            let currentGameState;
            try {
                const docSnap = await getDoc(doc(db, GAME_STATE_DOC_PATH, 'current'));
                if (docSnap.exists()) {
                    currentGameState = docSnap.data();
                } else {
                    currentGameState = { status: 'IDLE' };
                }
            } catch (error) {
                console.error("Error fetching game state for Guest: ", error);
                showCustomAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                return;
            }

            if (currentGameState.status !== 'RUNNING' && currentGameState.status !== 'PAUSED') {
                showCustomAlert('‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°! Guest ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°');
                return;
            }
            
            updateRole('Guest');
            showPage('game');
            startRealtimeListeners();
        });
        
        // --- EVENT LISTENERS (Game Page) ---

        
        logoutAdminButton.addEventListener('click', async () => {
             if (isAdmin) { 
                 try {
                    const gameStateDocRef = doc(db, GAME_STATE_DOC_PATH, 'current');
                    await setDoc(gameStateDocRef, { activeAdminId: null }, { merge: true }); 
                } catch (error) {
                    console.error("Error clearing activeAdminId on logout: ", error);
                }
            }
            sessionStorage.removeItem('currentUserRole');
            sessionStorage.removeItem('playerName'); 
            updateRole('Unknown');
            showPage('landing');
        });

        // Attach the shared handler to both player and guest logout buttons
        logoutGuestButton.addEventListener('click', handlePlayerGuestLogout);
        logoutPlayerButton.addEventListener('click', handlePlayerGuestLogout); 

    </script>

</body>
</html>