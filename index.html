<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alice in AI Land: Game (A-F Groups)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Theme: Black, Orange, White */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Gray/Black background */
        }
        .container {
            max-width: 1200px;
        }
        .vote-option:checked + label {
            background-color: #f97316; /* Orange 500 */
            border-color: #f97316;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.4), 0 2px 4px -2px rgba(249, 115, 22, 0.3);
        }
        .vote-option + label {
            transition: all 0.2s ease;
        }
        /* Custom Orange Scrollbar for better theme integration */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #f97316; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: #374151; }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-orange-500">Alice in AI Land: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</h1>
            <!-- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ -->
            <p class="text-lg text-gray-400 mt-2">‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤ 2 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <!-- Game Control (Admin) & Voting Form Section -->
            <div id="game-control-form-section" class="lg:col-span-1 space-y-8">
                
                <!-- GLOBAL TIMER DISPLAY (Visible to all when game is RUNNING) -->
                <div id="timer-display" class="bg-white p-4 rounded-xl shadow-2xl border border-gray-300 text-center hidden">
                    <p class="text-xl font-semibold text-gray-800 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</p>
                    <span id="timer-value" class="text-6xl font-extrabold text-orange-600">00:00</span>
                </div>

                <!-- Admin Control Container (Starts Hidden) -->
                <div id="admin-container" class="bg-white p-6 rounded-xl shadow-2xl border-4 border-gray-300">
                    <h2 class="text-2xl font-bold mb-4 text-orange-600 border-b pb-3">
                        ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Å‡∏° (Admin)
                    </h2>

                    <!-- Admin Login Form (Visible Initially) -->
                    <form id="admin-login-form">
                        <label for="admin-passcode-input" class="block text-sm font-medium text-gray-700 mb-2">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ Admin 4 ‡∏´‡∏•‡∏±‡∏Å</label>
                        <input type="password" id="admin-passcode-input" required maxlength="4" placeholder="****"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150 text-center text-xl font-mono text-gray-900">
                        <button type="submit"
                            class="w-full mt-4 bg-gray-500 text-white p-3 rounded-lg font-semibold hover:bg-gray-600 transition duration-200 shadow-md">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin
                        </button>
                    </form>
                    <p id="admin-login-message" class="mt-3 text-sm text-red-600 font-medium text-center"></p>

                    <!-- Game Control Panel (Hidden until logged in) -->
                    <div id="admin-control-panel" class="hidden">
                        <div id="game-status-display" class="mb-4 text-center p-3 rounded-lg font-bold text-lg">
                            <p id="status-text" class="text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>
                        </div>
                        <!-- Timer has been moved out of this panel -->

                        <button id="start-game-button" disabled
                            class="w-full bg-orange-500 text-white p-3 rounded-lg font-semibold hover:bg-orange-600 transition duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <!-- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ -->
                            ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° 2 ‡∏ô‡∏≤‡∏ó‡∏µ
                        </button>
                        <p class="text-xs text-gray-500 mt-2 text-center">
                            *‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ
                        </p>
                    </div>
                </div>
                
                <!-- Player Form -->
                <div id="vote-form-section" class="bg-white p-6 rounded-xl shadow-2xl h-fit border border-gray-300">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-3">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</h2>
                    
                    <div id="auth-status" class="text-sm text-red-500 mb-4 hidden">
                        <!-- Status message will appear here -->
                    </div>

                    <p id="block-message" class="text-center p-3 rounded-lg font-bold text-lg bg-red-100 text-red-700 hidden">
                        üö´ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    </p>

                    <form id="voting-form">
                        <div class="mb-5">
                            <label for="voter-name" class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</label>
                            <input type="text" id="voter-name" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150 text-gray-900">
                        </div>
                        
                        <div class="mb-6">
                            <!-- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å (0-5) ‡πÄ‡∏õ‡πá‡∏ô (A-F) -->
                            <label class="block text-sm font-medium text-gray-700 mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° (A - F)</label>
                            <div class="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-6 gap-3">
                                <!-- Group buttons A-F (Internal value 0-5) -->
                                <script>
                                    const groupLabels = ['A', 'B', 'C', 'D', 'E', 'F'];
                                    for (let i = 0; i <= 5; i++) {
                                        document.write(`
                                            <div>
                                                <input type="radio" id="vote-${i}" name="vote" value="${i}" required class="hidden vote-option">
                                                <label for="vote-${i}" 
                                                    class="flex justify-center items-center h-16 w-full text-xl font-bold border-2 border-gray-300 rounded-lg cursor-pointer select-none text-gray-600 hover:bg-orange-50 hover:border-orange-400">
                                                    <!-- ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Å‡∏•‡∏∏‡πà‡∏° " ‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏° -->
                                                    ${groupLabels[i]}
                                                </label>
                                            </div>
                                        `);
                                    }
                                </script>
                            </div>
                        </div>

                        <button type="submit" id="submit-button" disabled
                            class="w-full bg-orange-500 text-white p-3 rounded-lg font-semibold hover:bg-orange-600 transition duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°
                        </button>
                    </form>

                    <div id="vote-message" class="mt-4 text-center text-red-600 font-semibold hidden">
                        <!-- Success/Error message will appear here -->
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-2xl border border-gray-300">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-3">2. ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå)</h2>
                
                <div id="total-voters" class="mb-6 p-4 bg-gray-100 rounded-lg text-gray-800 font-semibold shadow-inner">
                    <span class="text-xl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span> <span id="voter-count" class="text-2xl font-bold ml-2 text-orange-600">0</span> ‡∏Ñ‡∏ô
                </div>

                <div id="results-container" class="space-y-6">
                    <p id="loading-message" class="text-center text-gray-500">
                        <svg class="animate-spin h-5 w-5 mr-3 inline text-orange-500" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°...
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, getDoc, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        const ADMIN_PASSCODE = '7793';
        const MAX_LOGIN_ATTEMPTS = 3;
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 120 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (2 ‡∏ô‡∏≤‡∏ó‡∏µ)
        const ADMIN_DURATION_SECONDS = 120; 
        let gameState = { status: 'IDLE', startTime: null, durationSeconds: ADMIN_DURATION_SECONDS };
        let timerInterval = null;
        const GROUP_LABELS = ['A', 'B', 'C', 'D', 'E', 'F'];
        let hasSubmittedInitialVote = false; // Flag ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

        // Admin Security State
        let isUserBlocked = false;
        let loginAttempts = 0;

        // Elements
        const form = document.getElementById('voting-form');
        const submitButton = document.getElementById('submit-button');
        const nameInput = document.getElementById('voter-name');
        const voteMessage = document.getElementById('vote-message');
        const resultsContainer = document.getElementById('results-container');
        const voterCountEl = document.getElementById('voter-count');
        const loadingMessage = document.getElementById('loading-message');
        const authStatusEl = document.getElementById('auth-status');
        const startGameButton = document.getElementById('start-game-button');
        const statusTextEl = document.getElementById('status-text');
        const timerDisplayEl = document.getElementById('timer-display'); // Global timer
        const timerValueEl = document.getElementById('timer-value'); // Global timer value
        const groupOptions = document.querySelectorAll('input[name="vote"]');
        
        // New Admin Elements
        const adminContainer = document.getElementById('admin-container');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminControlPanel = document.getElementById('admin-control-panel');
        const adminLoginMessageEl = document.getElementById('admin-login-message');
        const blockMessageEl = document.getElementById('block-message');

        // Firestore path
        const GAME_STATE_DOC_PATH = `artifacts/${appId}/public/data/gameState`;
        const VOTES_COLLECTION_PATH = `artifacts/${appId}/public/data/votes`;
        // Path ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Private Data)
        const BLOCK_STATUS_DOC_PATH = (uid) => `artifacts/${appId}/users/${uid}/status/adminBlock`;

        // Set Firebase log level for debugging
        setLogLevel('Debug');

        // --- FIREBASE INITIALIZATION & AUTH ---
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    
                    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    await checkBlockStatus(userId);

                    // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏° Listener
                    if (!isUserBlocked) {
                        startGameButton.disabled = false;
                        startRealtimeListeners();
                    } else {
                         // ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å, enableVotingForm ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ú‡πà‡∏≤‡∏ô handleAdminBlockStatus
                         console.log("User is permanently blocked from playing.");
                    }

                } else {
                    // Sign in if not authenticated
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        authStatusEl.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + error.message;
                        authStatusEl.classList.remove('hidden');
                    }
                }
            });

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            authStatusEl.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ: " + error.message;
            authStatusEl.classList.remove('hidden');
        }

        // --- ADMIN BLOCK LOGIC (PERSISTENCE) ---
        async function checkBlockStatus(uid) {
            if (!db) return;
            try {
                const blockDocRef = doc(db, BLOCK_STATUS_DOC_PATH(uid));
                const docSnap = await getDoc(blockDocRef);
                
                // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞ isBlocked ‡πÄ‡∏õ‡πá‡∏ô true
                if (docSnap.exists() && docSnap.data().isBlocked === true) {
                    handleAdminBlockStatus(true);
                } else {
                     handleAdminBlockStatus(false);
                }
            } catch (error) {
                console.error("Error fetching block status: ", error);
            }
        }

        async function blockUser(uid) {
            if (!db) return;
            try {
                const blockDocRef = doc(db, BLOCK_STATUS_DOC_PATH(uid));
                await setDoc(blockDocRef, { isBlocked: true, timestamp: serverTimestamp() });
                handleAdminBlockStatus(true);
            } catch (error) {
                console.error("Error blocking user: ", error);
            }
        }

        function handleAdminBlockStatus(isBlocked) {
            isUserBlocked = isBlocked;
            if (isBlocked) {
                blockMessageEl.classList.remove('hidden');
                nameInput.disabled = true;
                groupOptions.forEach(el => el.disabled = true);
                submitButton.disabled = true;
                submitButton.textContent = '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£';
                voteMessage.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô
            } else {
                blockMessageEl.classList.add('hidden');
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å enableVotingForm ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
                if (gameState.status) {
                    enableVotingForm(gameState.status === 'RUNNING');
                }
            }
        }


        // --- GAME STATE AND TIMER CONTROL ---
        function startRealtimeListeners() {
            if (!db || !userId) return;

            // 1. Listen to Game State
            onSnapshot(doc(db, GAME_STATE_DOC_PATH, 'current'), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    gameState = docSnapshot.data();
                    console.log("Game State Updated:", gameState);
                    handleGameStateChange();
                } else {
                    if (gameState.status !== 'RUNNING') {
                        setDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), gameState);
                        handleGameStateChange();
                    }
                }
            }, (error) => {
                console.error("Error fetching game state: ", error);
            });

            // 2. Listen to Votes
            const votesCollectionRef = collection(db, VOTES_COLLECTION_PATH);
            const q = query(votesCollectionRef);

            onSnapshot(q, (snapshot) => {
                loadingMessage.classList.add('hidden'); 
                const allVotes = [];
                const results = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [] };
                let userDocFound = false; 

                snapshot.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    allVotes.push(data);
                    
                    if (data.vote !== undefined && data.vote >= 0 && data.vote <= 5 && results[data.vote]) {
                        results[data.vote].push(data.name);
                    }

                    if (docSnapshot.id === userId) {
                        userDocFound = true;
                        nameInput.value = data.name;
                        const radio = document.querySelector(`input[name="vote"][value="${data.vote}"]`);
                        if (radio) radio.checked = true;
                    }
                });

                hasSubmittedInitialVote = userDocFound;
                
                renderResults(allVotes.length, results);
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°
                enableVotingForm(gameState.status === 'RUNNING');
                
            }, (error) => {
                console.error("Error fetching real-time votes: ", error);
                resultsContainer.innerHTML = '<p class="text-red-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏î‡πâ: ' + error.message + '</p>';
            });
        }

        function handleGameStateChange() {
            // ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠
            if (isUserBlocked) return; 

            clearInterval(timerInterval); 
            timerDisplayEl.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô Timer ‡∏Å‡πà‡∏≠‡∏ô
            
            // ‡∏õ‡∏∏‡πà‡∏° Admin ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å disabled ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login
            if (adminControlPanel.classList.contains('hidden')) {
                startGameButton.disabled = true; 
            } else {
                startGameButton.disabled = false;
            }


            const now = Date.now();

            if (gameState.status === 'RUNNING' && gameState.startTime && gameState.durationSeconds) {
                const startTimeMs = gameState.startTime.toMillis();
                const endTimeMs = startTimeMs + (gameState.durationSeconds * 1000);
                let remainingTimeSeconds = Math.max(0, Math.floor((endTimeMs - now) / 1000));

                if (remainingTimeSeconds > 0) {
                    // Game is RUNNING: Show Timer
                    timerDisplayEl.classList.remove('hidden');
                    startGameButton.textContent = '‡πÄ‡∏Å‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà...';
                    statusTextEl.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô!';
                    statusTextEl.className = 'text-center p-3 rounded-lg font-bold text-lg bg-red-100 text-red-600';
                    enableVotingForm(true);

                    timerInterval = setInterval(() => {
                        remainingTimeSeconds--;
                        if (remainingTimeSeconds < 0) remainingTimeSeconds = 0;
                        
                        const minutes = Math.floor(remainingTimeSeconds / 60);
                        const seconds = remainingTimeSeconds % 60;
                        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö MM:SS
                        timerValueEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        if (remainingTimeSeconds <= 0) {
                            clearInterval(timerInterval);
                            setDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                                status: 'IDLE',
                                startTime: null,
                                durationSeconds: ADMIN_DURATION_SECONDS
                            }, { merge: true });
                        }
                    }, 1000);
                } else {
                    handleGameOver();
                }

            } else {
                handleGameOver();
            }
        }

        function handleGameOver() {
            clearInterval(timerInterval);
            timerValueEl.textContent = '00:00';
            timerDisplayEl.classList.add('hidden'); // Hide Timer
            statusTextEl.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏à‡∏ö‡πÄ‡∏Å‡∏° / ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°';
            statusTextEl.className = 'text-center p-3 rounded-lg font-bold text-lg bg-gray-100 text-gray-600';
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ
            startGameButton.textContent = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° 2 ‡∏ô‡∏≤‡∏ó‡∏µ';
            // ‡∏õ‡∏∏‡πà‡∏° Admin ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å disabled ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login
            if (adminControlPanel.classList.contains('hidden')) {
                startGameButton.disabled = true; 
            } else {
                startGameButton.disabled = false;
            }
            enableVotingForm(false);
        }

        function enableVotingForm(isGameActive) {
            // ‡∏Å‡∏é: ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏•‡πá‡∏≠‡∏Å
            if (isUserBlocked) {
                handleAdminBlockStatus(true); 
                return;
            }

            const nameIsFilled = nameInput.value.trim() !== '';
            const voteIsSelected = document.querySelector('input[name="vote"]:checked');

            // ‡∏•‡πá‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Active (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤)
            nameInput.disabled = hasSubmittedInitialVote || !isGameActive;

            // ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Active
            groupOptions.forEach(el => el.disabled = !isGameActive);
            
            // ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° Submit: 1. ‡πÄ‡∏Å‡∏° Active, 2. ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà), 3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß
            const nameReady = hasSubmittedInitialVote || (isGameActive && nameIsFilled);
            const enableSubmit = isGameActive && nameReady && voteIsSelected;
            
            submitButton.disabled = !enableSubmit;
            
            if (isGameActive) {
                submitButton.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ)';
                if (hasSubmittedInitialVote) {
                    voteMessage.textContent = '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà!';
                    voteMessage.classList.remove('hidden', 'text-red-600');
                    voteMessage.classList.add('text-green-600');
                } else {
                    voteMessage.classList.add('hidden');
                }
            } else {
                submitButton.textContent = '‡∏à‡∏ö‡πÄ‡∏Å‡∏° / ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°';
                if (gameState.status === 'IDLE') {
                    voteMessage.textContent = '‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°';
                    voteMessage.classList.remove('hidden', 'text-green-600');
                    voteMessage.classList.add('text-red-600');
                }
            }
        }

        async function startGame() {
            if (!db || !userId) return;

            startGameButton.disabled = true;
            startGameButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...';
            
            try {
                const gameStateDocRef = doc(db, GAME_STATE_DOC_PATH, 'current');
                await setDoc(gameStateDocRef, {
                    status: 'RUNNING',
                    startTime: serverTimestamp(),
                    durationSeconds: ADMIN_DURATION_SECONDS,
                    adminId: userId 
                });
            } catch (error) {
                console.error("Error starting game: ", error);
                voteMessage.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ: ' + error.message;
                voteMessage.classList.remove('hidden', 'text-green-600');
                voteMessage.classList.add('text-red-600');
                startGameButton.disabled = false;
                startGameButton.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà';
            }
        }

        // --- UI RENDERING (No change, left for completeness) ---

        function renderResults(totalCount, results) {
            voterCountEl.textContent = totalCount;
            resultsContainer.innerHTML = ''; 

            const voteCounts = Object.keys(results).map(vote => ({
                number: parseInt(vote),
                count: results[vote].length,
                names: results[vote]
            }));

            voteCounts.sort((a, b) => a.number - b.number);

            voteCounts.forEach(({ number, count, names }) => {
                const percentage = totalCount > 0 ? (count / totalCount) * 100 : 0;
                const groupLabel = GROUP_LABELS[number];

                const namesList = names.length > 0
                    ? `<ul class="list-disc list-inside mt-3 ml-4 space-y-1 text-gray-700 max-h-40 overflow-y-auto">
                           ${names.map(name => `<li class="text-sm">${name}</li>`).join('')}
                       </ul>`
                    : '<p class="text-sm italic text-gray-500 mt-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</p>';

                const resultBlock = `
                    <div class="bg-gray-50 p-4 rounded-lg shadow-md border-l-4 border-orange-500">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold text-gray-800">
                                ‡∏Å‡∏•‡∏∏‡πà‡∏° <span class="text-orange-600">${groupLabel}</span>
                            </h3>
                            <span class="text-3xl font-extrabold text-orange-700">${count}</span>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
                            <div class="bg-orange-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô: ${percentage.toFixed(1)}%</p>
                        
                        <!-- Voter List -->
                        <div class="mt-4 pt-3 border-t border-gray-200">
                            <h4 class="font-semibold text-gray-700">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (${names.length} ‡∏Ñ‡∏ô):</h4>
                            ${namesList}
                        </div>
                    </div>
                `;
                resultsContainer.innerHTML += resultBlock;
            });
        }

        // --- EVENT LISTENERS (Updated with Admin Login) ---

        // Admin Passcode Submission
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const passcode = document.getElementById('admin-passcode-input').value.trim();

            if (passcode === ADMIN_PASSCODE) {
                adminLoginForm.classList.add('hidden');
                adminControlPanel.classList.remove('hidden');
                startGameButton.disabled = false; // Enable start button for admin
                adminLoginMessageEl.textContent = '‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                adminLoginMessageEl.className = 'mt-3 text-sm text-green-600 font-medium text-center';
                
            } else {
                loginAttempts++;
                const remaining = MAX_LOGIN_ATTEMPTS - loginAttempts;

                if (remaining > 0) {
                    adminLoginMessageEl.textContent = `‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡∏µ‡∏Å ${remaining} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
                    adminLoginMessageEl.className = 'mt-3 text-sm text-red-600 font-medium text-center';
                } else {
                    adminLoginMessageEl.textContent = 'üõë ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏°‡∏ñ‡∏≤‡∏ß‡∏£';
                    adminLoginMessageEl.className = 'mt-3 text-sm text-red-700 font-bold text-center';
                    adminLoginForm.querySelector('input').disabled = true;
                    adminLoginForm.querySelector('button').disabled = true;
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£‡∏•‡∏á‡πÉ‡∏ô Firestore
                    if (userId) {
                        await blockUser(userId);
                    }
                }
            }
            document.getElementById('admin-passcode-input').value = ''; 
        });


        // Admin Start Button
        startGameButton.addEventListener('click', startGame);

        // Player Submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (isUserBlocked) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß

            if (gameState.status !== 'RUNNING') {
                voteMessage.textContent = '‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°! ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°';
                voteMessage.classList.remove('hidden', 'text-green-600');
                voteMessage.classList.add('text-red-600');
                return;
            }

            if (!userId) {
                voteMessage.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö... ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
                voteMessage.classList.remove('hidden', 'text-green-600');
                voteMessage.classList.add('text-red-600');
                return;
            }

            const nameInput = document.getElementById('voter-name').value.trim();
            const selectedVote = document.querySelector('input[name="vote"]:checked');

            if (nameInput === "" || !selectedVote) {
                voteMessage.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°';
                voteMessage.classList.remove('hidden', 'text-green-600');
                voteMessage.classList.add('text-red-600');
                return;
            }

            const voteValue = parseInt(selectedVote.value);

            submitButton.disabled = true;
            submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...';

            try {
                const voteDocRef = doc(db, VOTES_COLLECTION_PATH, userId);

                await setDoc(voteDocRef, {
                    name: nameInput,
                    vote: voteValue,
                    timestamp: serverTimestamp(),
                    userId: userId 
                }, { merge: true }); 

                voteMessage.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà';
                voteMessage.classList.remove('hidden', 'text-red-600');
                voteMessage.classList.add('text-green-600');
                
                submitButton.disabled = false;
                submitButton.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ)';

            } catch (error) {
                console.error("Error submitting vote: ", error);
                voteMessage.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message;
                voteMessage.classList.remove('hidden', 'text-green-600');
                voteMessage.classList.add('text-red-600');
                
                submitButton.disabled = false;
                submitButton.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ)';
            }
        });
        
        // Watch for changes to re-evaluate form state
        nameInput.addEventListener('input', () => {
            enableVotingForm(gameState.status === 'RUNNING');
        });

        groupOptions.forEach(option => {
            option.addEventListener('change', () => {
                enableVotingForm(gameState.status === 'RUNNING');
            });
        });

    </script>

</body>
</html>