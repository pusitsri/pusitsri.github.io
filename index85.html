<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alice in AI Land : Golden Opportunity</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Theme: Black, Orange, White */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Gray/Black background */
        }
        .container {
            max-width: 1200px;
        }
        /* Custom Orange Scrollbar for better theme integration */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #f97316; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: #374151; }
        /* Utility for simulating page switch */
        .page-hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8 relative"> <!-- Added relative for admin toggle positioning -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-orange-500">Alice in AI Land : Golden Opportunity</h1>
            
            <!-- Gold Price Display (NOW SHOWS ADMIN BASE PRICE) -->
            <p id="gold-price-display" class="text-lg text-yellow-500 mt-1 font-semibold">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ê‡∏≤‡∏ô...
            </p>

            <!-- Subtitle is used for Landing Page text -->
            <p id="header-subtitle" class="text-lg text-gray-400 mt-2">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏°</p>
            
            <!-- Total Voter Count Display for Game Page (Hidden by default, positioned in header) -->
            <div id="game-voter-summary" class="text-lg text-gray-300 mt-2 hidden">
                <span class="text-xl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span> 
                <span id="voter-count-header" class="text-2xl font-bold ml-2 text-orange-400">0</span> 
                <span>‡∏Ñ‡∏ô</span>
            </div>
        </header>

        <!-- ============================================== -->
        <!-- STEP 1: LANDING/AUTH PAGE -->
        <!-- ============================================== -->
        <div class="relative max-w-4xl mx-auto">
            <!-- Admin Toggle Link (New Element: Positioned top-left) -->
            <button id="admin-toggle-link" class="absolute top-[-1.5rem] left-4 text-sm text-gray-400 hover:text-orange-500 transition duration-200">
                üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin
            </button>
            <!-- Error message will now be shown via dialog, this is just for visual space -->
            <p id="guest-access-error" class="absolute top-[-1.5rem] right-4 text-sm text-red-500 font-medium hidden"></p> 

            <!-- Landing Page Grid -->
            <div id="landing-page" class="grid grid-cols-1 md:grid-cols-3 gap-8 page-hidden">
                
                <!-- Admin Login (Initially Hidden, Toggle by Link) -->
                <div id="landing-admin-card" class="bg-white p-6 rounded-xl shadow-2xl border-4 border-gray-300 hidden">
                    <h2 class="text-2xl font-bold mb-4 text-orange-600 border-b pb-3">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin
                    </h2>
                    <form id="admin-login-form">
                        <label for="admin-passcode-input" class="block text-sm font-medium text-gray-700 mb-2">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ Admin 4 ‡∏´‡∏•‡∏±‡∏Å</label>
                        <input type="password" id="admin-passcode-input" required maxlength="4" placeholder="****"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150 text-center text-xl font-mono text-gray-900">
                        <button type="submit" id="landing-admin-btn"
                            class="w-full mt-4 bg-gray-500 text-white p-3 rounded-lg font-semibold hover:bg-gray-600 transition duration-200 shadow-md">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin
                        </button>
                    </form>
                    <p id="admin-login-message" class="mt-3 text-sm text-red-600 font-medium text-center"></p>
                </div>

                <!-- Player Registration / Resume Card -->
                <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-300 col-span-1 md:col-span-1" id="player-card"> 
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-3">
                        ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
                    </h2>
                    
                    <!-- Content for NEW Player (Default) -->
                    <div id="player-card-content"> 
                        <form id="player-registration-form">
                            <label for="player-name-input" class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</label>
                            <input type="text" id="player-name-input" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150 text-gray-900">
                            <button type="submit"
                                class="w-full mt-4 bg-orange-500 text-white p-3 rounded-lg font-semibold hover:bg-orange-600 transition duration-200 shadow-md">
                                ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°
                            </button>
                        </form>
                    </div>

                    <!-- Content for RETURNING Player (Hidden by default, shown via JS) -->
                    <div id="player-resume-content" class="hidden">
                        <p class="text-lg text-gray-700 mb-4">
                            ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤, <span id="resumed-player-name" class="font-bold text-orange-600"></span>!
                        </p>
                        <button id="resume-player-button" class="w-full mt-2 bg-orange-500 text-white p-3 rounded-lg font-semibold hover:bg-orange-600 transition duration-200 shadow-md">
                            ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ
                        </button>
                        <!-- NEW CHANGE NAME BUTTON -->
                        <button id="change-player-name-button" class="w-full mt-3 bg-red-400 text-white p-3 rounded-lg font-semibold hover:bg-red-500 transition duration-200 shadow-md disabled:opacity-50 disabled:bg-gray-400 disabled:hover:bg-gray-400">
                            ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
                        </button>
                        <button id="resume-as-guest-button" class="w-full mt-3 bg-gray-200 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 shadow-md border border-gray-400">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Guest Mode)
                        </button>
                    </div>

                    <p class="text-sm text-gray-500 mt-3 text-center">
                        (‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
                    </p>
                </div>

                <!-- Guest Access -->
                <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-300 flex flex-col justify-between col-span-1 md:col-span-1">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-3">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                        </h2>
                        <p class="text-gray-600 mb-4">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ (‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
                        </p>
                    </div>
                    <button id="guest-access-button"
                        class="w-full bg-gray-200 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 shadow-md border border-gray-400">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏° (Guest)
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- STEP 2: GAME PAGE -->
        <!-- ============================================== -->
        <div id="game-page" class="grid grid-cols-1 lg:grid-cols-3 gap-10 page-hidden">
            
            <!-- Game Control, Timer & Player/Guest Area -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- GLOBAL TIMER DISPLAY (Visible to all when game is RUNNING) -->
                <div id="timer-display" class="bg-white p-4 rounded-xl shadow-2xl border border-gray-300 text-center hidden">
                    <p class="text-xl font-semibold text-gray-800 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</p>
                    <span id="timer-value" class="text-6xl font-extrabold text-orange-600">00:00</span>
                </div>

                <!-- Admin Control Panel (Visible only to Admin) -->
                <div id="admin-control-panel" class="bg-white p-6 rounded-xl shadow-2xl border-4 border-orange-500 hidden">
                    <h2 class="2xl font-bold mb-4 text-orange-600 border-b pb-3">
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Å‡∏°
                    </h2>
                    
                    <!-- Gold Price Base Input (NEW) -->
                    <div class="mb-4">
                        <label for="gold-price-base-input" class="block text-sm font-medium text-gray-700 mb-2">
                            ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ê‡∏≤‡∏ô‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ 1 ‡∏ö‡∏≤‡∏ó (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•)
                        </label>
                        <input type="number" id="gold-price-base-input" min="1000" step="100" 
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 text-right font-mono"
                            value="64000" disabled>
                        <p class="text-xs text-gray-500 mt-1">
                            ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '‡∏à‡∏ö‡πÄ‡∏Å‡∏° / ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°'
                        </p>
                    </div>
                    
                    <!-- MODIFIED: Reward Visibility Radio Group + Confirm Button -->
                    <div class="mb-4 p-3 border border-gray-300 rounded-lg bg-gray-50">
                        <h3 class="text-sm font-medium text-gray-700 mb-2 border-b pb-1">
                            ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (Real-time)
                        </h3>
                        <div class="flex flex-col space-y-2 mb-3">
                            <label class="inline-flex items-center text-gray-700">
                                <input type="radio" name="rewardVisibility" id="radio-show-rewards" value="show"
                                       class="form-radio h-4 w-4 text-green-600 focus:ring-green-500">
                                <span class="ml-2 text-sm font-medium">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</span>
                            </label>
                            <label class="inline-flex items-center text-gray-700">
                                <input type="radio" name="rewardVisibility" id="radio-hide-rewards" value="hide"
                                       class="form-radio h-4 w-4 text-red-600 focus:ring-red-500">
                                <span class="ml-2 text-sm font-medium">‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡πÅ‡∏ó‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 'x')</span>
                            </label>
                        </div>
                        <button id="confirm-rewards-visibility-btn"
                                class="w-full bg-orange-500 text-white p-2 rounded-lg font-semibold hover:bg-orange-600 transition duration-200 shadow-md disabled:opacity-50">
                            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                        </button>
                        <p id="rewards-update-message" class="text-xs mt-2 text-center text-gray-600"></p>
                    </div>


                    <!-- NEW: Admin Passcode Configuration -->
                    <div class="mb-4 p-3 border border-red-300 rounded-lg bg-red-50">
                        <h3 class="text-lg font-bold text-red-700 mb-2">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™ Admin</h3>
                        <label for="new-admin-passcode-input" class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™ Admin ‡πÉ‡∏´‡∏°‡πà (4 ‡∏´‡∏•‡∏±‡∏Å)</label>
                        <div class="flex space-x-2">
                            <input type="password" id="new-admin-passcode-input" required maxlength="4" placeholder="****"
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 text-center text-xl font-mono text-gray-900">
                            <button id="update-passcode-btn" 
                                class="bg-red-500 text-white p-2 rounded-lg font-semibold hover:bg-red-600 transition duration-200 shadow-md">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™
                            </button>
                        </div>
                        <p id="passcode-update-message" class="text-sm mt-2 text-center text-gray-600"></p>
                    </div>

                    <div id="game-status-display" class="mb-4 text-center p-3 rounded-lg font-bold text-lg">
                        <p id="status-text" class="text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>
                    </div>
                    
                    <!-- Timer Adjustments -->
                    <div class="mb-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</h3>
                        <div class="flex justify-between items-center space-x-2">
                            <button id="time-minus-btn" disabled 
                                class="w-1/2 bg-gray-600 text-white p-2 rounded-lg font-semibold hover:bg-gray-700 transition duration-200 disabled:opacity-50">
                                - 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                            </button>
                            <button id="time-plus-btn" disabled 
                                class="w-1/2 bg-gray-600 text-white p-2 rounded-lg font-semibold hover:bg-gray-700 transition duration-200 disabled:opacity-50">
                                + 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                            </button>
                        </div>
                    </div>


                    <!-- Main Control Buttons -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button id="main-control-button" disabled
                            class="col-span-1 bg-orange-500 text-white p-3 rounded-lg font-semibold hover:bg-orange-600 transition duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                        </button>
                        <button id="terminate-button" disabled
                            class="col-span-1 bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        </button>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-2 text-center">
                        *Admin ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ
                    </p>
                    <button id="logout-admin-button"
                        class="w-full mt-4 bg-gray-400 text-gray-800 p-2 rounded-lg font-semibold hover:bg-gray-500 transition duration-200 shadow-md">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin
                    </button>
                </div>
                
                <!-- NEW: Admin Player List Panel (Visible only to Admin) -->
                <div id="admin-player-list-panel" class="bg-white p-6 rounded-xl shadow-2xl border border-gray-300 hidden">
                    <h2 class="text-2xl font-bold mb-4 text-orange-600 border-b pb-3">
                        ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="admin-total-players" class="text-gray-600">0</span> ‡∏Ñ‡∏ô)
                    </h2 >
                    <div id="admin-player-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <p class="text-sm italic text-gray-500">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô...</p>
                    </div>
                </div>

                <!-- Player Info and Message (NEW SECTION) -->
                <div id="player-info-section" class="bg-white p-6 rounded-xl shadow-2xl h-fit border border-gray-300 hidden">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>
                    
                    <p id="player-name-display" class="text-lg font-semibold text-gray-700 mb-4">
                        ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: <span id="current-player-name" class="text-orange-600"></span>
                    </p>

                    <div id="vote-message-container">
                        <p id="vote-message" class="mt-4 text-center text-red-600 font-semibold hidden">
                            <!-- Success/Error message will appear here -->
                        </p>
                    </div>
                    
                    <!-- LOGOUT BUTTON FOR PLAYER -->
                    <button id="logout-player-button" 
                        class="w-full mt-4 bg-gray-200 text-gray-700 p-2 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 shadow-md border border-gray-400">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)
                    </button>
                </div>

                <!-- Guest/Blocked Message Area (Visible to Guests or Blocked Users) -->
                <div id="guest-view-section" class="bg-white p-6 rounded-xl shadow-2xl h-fit border border-gray-300 hidden">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏ä‡∏° (Guest View)</h2>
                    <p class="text-gray-600 mb-4">‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ</p>
                    <p id="guest-block-message" class="text-center p-3 rounded-lg font-bold text-lg bg-red-100 text-red-700 hidden">
                        <!-- Removed: Block message UI element is now unused -->
                    </p>
                    <button id="logout-guest-button"
                        class="w-full mt-4 bg-gray-200 text-gray-700 p-2 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 shadow-md border border-gray-400">
                        ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                    </button>
                </div>
            </div>

            <!-- Results Section (Visible to all roles) -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-2xl border border-gray-300">
                <!-- MODIFIED TITLE -->
                <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå)</h2>
                
                <!-- Updated to use Grid for distinct boxes -->
                <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p id="loading-message" class="col-span-full text-center text-gray-500">
                        <svg class="animate-spin h-5 w-5 mr-3 inline text-orange-500" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏°...
                    </p>
                </div>
            </div>
        </div>

    </div>
    
    <!-- Custom Alert Dialog (Hidden by Default) -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-xl max-w-sm w-full shadow-2xl border-4 border-red-500">
            <h3 class="text-2xl font-bold text-red-600 mb-4">üõë ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
            <p id="custom-alert-message" class="text-gray-700 mb-6"></p>
            <button id="custom-alert-close-btn" class="w-full bg-red-500 text-white p-3 rounded-lg font-semibold hover:bg-red-600 transition duration-200 shadow-lg">
                ‡∏ï‡∏Å‡∏•‡∏á
            </button>
        </div>
    </div>
    
    <!-- FOOTER: VERSION NUMBER (UPDATED TO 0.74) -->
    <footer class="text-center mt-10 p-4 text-gray-600 text-xs">
        ver 0.85
    </footer>


    <!-- Firebase SDKs (De-obfuscated) -->
    <script type="module">
        import {initializeApp} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, deleteDoc, getDocs, updateDoc} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const DEFAULT_ADMIN_PASSCODE = '0000';
        const DEFAULT_DURATION_SECONDS = 120;
        const DEFAULT_GOLD_PRICE = 64000;
        const TIME_ADJUST_SECONDS = 30;
        const GROUP_LABELS = ['A', 'B', 'C', 'D', 'E'];

        // State Variables
        let gameState = {status: 'IDLE', endTime: null, remainingTimeSeconds: DEFAULT_DURATION_SECONDS, newGameTimestamp: null, currentGoldPriceBase: DEFAULT_GOLD_PRICE, showRewards: true};
        let timerInterval = null;
        let hasSubmittedInitialVote = false;
        let currentUserRole = 'Unknown';
        let isAdmin = false;
        let isPlayer = false;
        let isGuest = false;
        let playerName = '';
        let currentAdminPasscode = DEFAULT_ADMIN_PASSCODE;

        // Firebase Configuration (for external hosting)
        const customFirebaseConfig = {apiKey:"AIzaSyDOrTeFqzQJNtz0bR327Z7HiM3F4pjxKyA",authDomain:"alice-game-b2aa5.firebaseapp.com",projectId:"alice-game-b2aa5",storageBucket:"alice-game-b2aa5.firebasestorage.app",messagingSenderId:"70768832876",appId:"1:70768832876:web:e3d908f7b1a9f1d1458349"};
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : customFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firebase Instances
        let db;
        let auth;
        let userId = null;

        // DOM Elements
        const headerSubtitleEl = document.getElementById('header-subtitle');
        const landingPageEl = document.getElementById('landing-page');
        const gamePageEl = document.getElementById('game-page');
        const adminToggleLinkEl = document.getElementById('admin-toggle-link');
        const landingAdminCardEl = document.getElementById('landing-admin-card');
        const adminLoginFormEl = document.getElementById('admin-login-form');
        const playerRegistrationFormEl = document.getElementById('player-registration-form');
        const playerCardContentEl = document.getElementById('player-card-content');
        const playerResumeContentEl = document.getElementById('player-resume-content');
        const resumePlayerButtonEl = document.getElementById('resume-player-button');
        const resumeAsGuestButtonEl = document.getElementById('resume-as-guest-button');
        const resumedPlayerNameEl = document.getElementById('resumed-player-name');
        const guestAccessButtonEl = document.getElementById('guest-access-button');
        const adminLoginMessageEl = document.getElementById('admin-login-message');
        const adminPasscodeInputEl = document.getElementById('admin-passcode-input');
        const playerNameInputEl = document.getElementById('player-name-input');
        const guestAccessErrorEl = document.getElementById('guest-access-error');
        const customAlertModalEl = document.getElementById('custom-alert-modal');
        const customAlertMessageEl = document.getElementById('custom-alert-message');
        const customAlertCloseBtnEl = document.getElementById('custom-alert-close-btn');
        const adminControlPanelEl = document.getElementById('admin-control-panel');
        const adminPlayerListPanelEl = document.getElementById('admin-player-list-panel');
        const adminTotalPlayersEl = document.getElementById('admin-total-players');
        const adminPlayerListEl = document.getElementById('admin-player-list');
        const playerInfoSectionEl = document.getElementById('player-info-section');
        const guestViewSectionEl = document.getElementById('guest-view-section');
        const currentPlayerNameEl = document.getElementById('current-player-name');
        const logoutAdminButtonEl = document.getElementById('logout-admin-button');
        const logoutGuestButtonEl = document.getElementById('logout-guest-button');
        const logoutPlayerButtonEl = document.getElementById('logout-player-button');
        const gameVoterSummaryEl = document.getElementById('game-voter-summary');
        const voterCountHeaderEl = document.getElementById('voter-count-header');
        const goldPriceDisplayEl = document.getElementById('gold-price-display');
        const goldPriceBaseInputEl = document.getElementById('gold-price-base-input');
        const newAdminPasscodeInputEl = document.getElementById('new-admin-passcode-input');
        const updatePasscodeBtnEl = document.getElementById('update-passcode-btn');
        const passcodeUpdateMessageEl = document.getElementById('passcode-update-message');
        const mainControlButtonEl = document.getElementById('main-control-button');
        const terminateButtonEl = document.getElementById('terminate-button');
        const timePlusBtnEl = document.getElementById('time-plus-btn');
        const timeMinusBtnEl = document.getElementById('time-minus-btn');
        const voteMessageEl = document.getElementById('vote-message');
        const resultsContainerEl = document.getElementById('results-container');
        const loadingMessageEl = document.getElementById('loading-message');
        const authStatusEl = document.getElementById('auth-status');
        const statusTextEl = document.getElementById('status-text');
        const timerDisplayEl = document.getElementById('timer-display');
        const timerValueEl = document.getElementById('timer-value');
        const changePlayerNameButtonEl = document.getElementById('change-player-name-button');
        // NEW DOM
        const radioShowRewardsEl = document.getElementById('radio-show-rewards'); 
        const radioHideRewardsEl = document.getElementById('radio-hide-rewards');
        const confirmRewardsVisibilityBtnEl = document.getElementById('confirm-rewards-visibility-btn');
        const rewardsUpdateMessageEl = document.getElementById('rewards-update-message');


        // Firestore Paths
        const GAME_STATE_DOC_PATH = `artifacts/${appId}/public/data/gameState`;
        const VOTES_COLLECTION_PATH = `artifacts/${appId}/public/data/votes`;
        const ADMIN_CONFIG_DOC_PATH = `artifacts/${appId}/public/data/adminConfig`;

        // Enable Firebase Debug Logging
        setLogLevel('Debug');

        // --- UI Functions ---

        function showAlert(message) {
            customAlertMessageEl.textContent = message;
            customAlertModalEl.classList.remove('hidden');
        }

        function hideAlert() {
            customAlertModalEl.classList.add('hidden');
        }

        function playClickSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.15);
        }

        function formatGoldWeight(unit) {
            if (unit === 1) return '1 ‡∏ö‡∏≤‡∏ó';
            if (unit === 0.50) return '50 ‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå';
            if (unit === 0.25) return '25 ‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå';
            return '0 ‡∏ö‡∏≤‡∏ó';
        }

        // NEW Utility function for masking monetary value
        function maskMonetaryValue(value) {
            // If value is exactly zero, the toLocaleString() returns '0' or '0.00'
            const valueString = value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            // Mask all digits and separators, keeping the '.xx' format logic
            const masked = valueString.replace(/[0-9]/g, 'x');

            // Since we need to mask 0 as well, we only check if the original value is truly 0.
            if (value === 0 || value === 0.00) {
                 return 'x.xx'; 
            }
            
            // Ensure the result is correctly masked (e.g., '64,000.00' -> 'xx,xxx.xx')
            return masked;
        }

        function showPage(pageId) {
            // Hide all pages and admin toggle link first
            landingPageEl.classList.add('page-hidden');
            gamePageEl.classList.add('page-hidden');
            adminToggleLinkEl.classList.add('hidden');

            if (pageId === 'landing') {
                landingPageEl.classList.remove('page-hidden');
                headerSubtitleEl.classList.remove('hidden');
                gameVoterSummaryEl.classList.add('hidden');
                headerSubtitleEl.textContent = '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏°';
                adminLoginMessageEl.classList.add('hidden');
                guestAccessErrorEl.classList.add('hidden');
                renderLandingPageUI();
                // Only show admin toggle link on the landing page
                adminToggleLinkEl.classList.remove('hidden');
                goldPriceDisplayEl.classList.add('hidden');
            } else { // 'game' page
                gamePageEl.classList.remove('page-hidden');
                headerSubtitleEl.classList.add('hidden');
                gameVoterSummaryEl.classList.remove('hidden');
                goldPriceDisplayEl.classList.remove('hidden');
            }
        }

        function renderLandingPageUI() {
            const storedName = sessionStorage.getItem('playerName');
            
            // Reset layout for landing page (default: 2 columns wide)
            landingPageEl.classList.remove('md:grid-cols-3');
            landingPageEl.classList.add('md:grid-cols-2', 'md:max-w-xl');
            document.getElementById('player-card').classList.add('md:col-span-1');
            landingAdminCardEl.classList.add('hidden'); // Ensure admin login is hidden initially
            
            // Check if user has a stored name and hasn't explicitly been forced to re-register
            if (storedName && !playerNameInputEl.dataset.forceRegister) {
                // Show Resume Content
                playerCardContentEl.classList.add('hidden');
                playerResumeContentEl.classList.remove('hidden');
                resumedPlayerNameEl.textContent = storedName;
            } else {
                // Show New Registration Content
                playerCardContentEl.classList.remove('hidden');
                playerResumeContentEl.classList.add('hidden');
                playerNameInputEl.dataset.forceRegister = ''; // Clear flag
            }
        }

        function updateUserRole(role, name = '') {
            currentUserRole = role;
            isAdmin = role === 'Admin';
            isPlayer = role === 'Player';
            isGuest = role === 'Guest';
            playerName = name;
            
            sessionStorage.setItem('currentUserRole', role);
            if (name) sessionStorage.setItem('playerName', name);
            
            renderGamePageUI();
        }

        function renderGamePageUI() {
            // Hide all role-specific panels first
            adminControlPanelEl.classList.add('hidden');
            adminPlayerListPanelEl.classList.add('hidden');
            playerInfoSectionEl.classList.add('hidden');
            guestViewSectionEl.classList.add('hidden');

            if (isAdmin) {
                adminControlPanelEl.classList.remove('hidden');
                adminPlayerListPanelEl.classList.remove('hidden');
            } else if (isPlayer) {
                playerInfoSectionEl.classList.remove('hidden');
                currentPlayerNameEl.textContent = playerName;
            } else if (isGuest) {
                guestViewSectionEl.classList.remove('hidden');
            }
        }

        // --- Firebase Initialization ---

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const role = sessionStorage.getItem('currentUserRole');
                    const name = sessionStorage.getItem('playerName') || '';
                    
                    if (role && role !== 'Unknown') {
                        updateUserRole(role, name);
                        setupRealtimeListeners();
                        showPage('game');
                    } else {
                        showPage('landing');
                    }
                } else {
                    try {
                        // Sign in anonymously if no token is available, otherwise use custom token
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        authStatusEl.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Auth): " + error.message;
                        authStatusEl.classList.remove('hidden');
                    }
                }
            });
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            authStatusEl.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ: " + error.message;
            authStatusEl.classList.remove('hidden');
        }

        // --- Game Logic Functions ---

        async function autoAssignPlayer(uid, name) {
            if (!db || !name) return;
            const randomGroupIndex = Math.floor(Math.random() * GROUP_LABELS.length);
            const randomGroupLabel = GROUP_LABELS[randomGroupIndex];

            console.log(`Auto-assigning ${name} to Group ${randomGroupLabel} (${randomGroupIndex})`);

            try {
                await setDoc(doc(db, VOTES_COLLECTION_PATH, uid), {
                    name: name,
                    vote: randomGroupIndex,
                    timestamp: serverTimestamp(),
                    userId: uid
                }, { merge: true });

                voteMessageEl.textContent = `‚úÖ ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏° ${randomGroupLabel} ‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ`;
                voteMessageEl.classList.remove('hidden', 'text-red-600');
                voteMessageEl.classList.add('text-green-600');
                playClickSound();
                setTimeout(() => voteMessageEl.classList.add('hidden'), 5000);
            } catch (error) {
                console.error("Error auto-assigning vote: ", error);
                voteMessageEl.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°: ' + error.message;
                voteMessageEl.classList.add('text-red-600');
            }
        }
        
        function setupRealtimeListeners() {
            if (!db || !userId) return;

            // 1. Admin Config Listener (Passcode)
            onSnapshot(doc(db, ADMIN_CONFIG_DOC_PATH, 'current'), (docSnap) => {
                if (docSnap.exists()) {
                    currentAdminPasscode = docSnap.data().passcode;
                    // Ensure passcode is valid, otherwise reset to default
                    if (typeof currentAdminPasscode !== 'string' || currentAdminPasscode.length !== 4) {
                        currentAdminPasscode = DEFAULT_ADMIN_PASSCODE;
                    }
                } else {
                    // Create default passcode if document doesn't exist
                    setDoc(doc(db, ADMIN_CONFIG_DOC_PATH, 'current'), {
                        passcode: DEFAULT_ADMIN_PASSCODE,
                        lastUpdatedBy: null,
                        timestamp: serverTimestamp()
                    }, { merge: true });
                    currentAdminPasscode = DEFAULT_ADMIN_PASSCODE;
                }
            }, (error) => {
                console.error("Error fetching admin config: ", error);
            });

            // 2. Game State Listener
            onSnapshot(doc(db, GAME_STATE_DOC_PATH, 'current'), (docSnap) => {
                if (docSnap.exists()) {
                    gameState = docSnap.data();
                    handleGameStateChange();
                } else if (gameState.status === 'IDLE') {
                    // Ensure game state document exists if it should be IDLE
                    setDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                        status: 'IDLE',
                        endTime: null,
                        remainingTimeSeconds: DEFAULT_DURATION_SECONDS,
                        newGameTimestamp: serverTimestamp(),
                        currentGoldPriceBase: DEFAULT_GOLD_PRICE,
                        showRewards: true
                    }, { merge: true });
                }
                handleGameStateChange();
            }, (error) => {
                console.error("Error fetching game state: ", error);
            });

            // 3. Votes Listener (Main Data)
            const votesCollection = collection(db, VOTES_COLLECTION_PATH);
            const votesQuery = query(votesCollection);
            onSnapshot(votesQuery, (querySnapshot) => {
                loadingMessageEl.classList.add('hidden');
                
                const allVotes = [];
                const groupedVotes = {0: [], 1: [], 2: [], 3: [], 4: []};
                let playerHasVoted = false;
                let playerCurrentVote = -1;

                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    allVotes.push(data);
                    
                    // Group votes by group index (0-4)
                    if (data.vote !== undefined && data.vote >= 0 && data.vote <= 4 && groupedVotes[data.vote]) {
                        groupedVotes[data.vote].push(data.name);
                    }

                    // Check player's status
                    if (docSnap.id === userId && isPlayer) {
                        playerHasVoted = true;
                        playerCurrentVote = data.vote;
                    }
                });
                
                // Auto-assign player if registered but hasn't voted yet and game is running
                if (isPlayer && gameState.status === 'RUNNING' && !playerHasVoted) {
                    console.log("Player registered and game is running. Auto-assigning group...");
                    autoAssignPlayer(userId, playerName);
                }
                
                hasSubmittedInitialVote = playerHasVoted;
                renderResultsAndAdminList(allVotes.length, groupedVotes, playerCurrentVote);
            }, (error) => {
                console.error("Error fetching real-time votes: ", error);
                resultsContainerEl.innerHTML = '<p class="text-red-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏î‡πâ: ' + error.message + '</p>';
            });
        }

        function updateAdminControls(status) {
            if (!isAdmin) return;
            
            terminateButtonEl.disabled = (status === 'IDLE');
            timePlusBtnEl.disabled = (status === 'IDLE');
            timeMinusBtnEl.disabled = (status === 'IDLE');
            goldPriceBaseInputEl.disabled = (status !== 'IDLE'); // Only editable when IDLE

            if (status === 'IDLE') {
                mainControlButtonEl.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡πÄ‡∏Å‡πà‡∏≤)';
                mainControlButtonEl.classList.remove('bg-yellow-500', 'bg-green-500');
                mainControlButtonEl.classList.add('bg-orange-500');
            } else if (status === 'RUNNING') {
                mainControlButtonEl.textContent = '‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (Pause)';
                mainControlButtonEl.classList.remove('bg-orange-500', 'bg-green-500');
                mainControlButtonEl.classList.add('bg-yellow-500');
            } else if (status === 'PAUSED') {
                mainControlButtonEl.textContent = '‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠ (Resume)';
                mainControlButtonEl.classList.remove('bg-orange-500', 'bg-yellow-500');
                mainControlButtonEl.classList.add('bg-green-500');
            }
            mainControlButtonEl.disabled = false;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function handleGameStateChange() {
            clearInterval(timerInterval);
            timerDisplayEl.classList.add('hidden');
            
            const newGameTimestamp = gameState.newGameTimestamp?.toMillis();
            const latestGameTimestamp = sessionStorage.getItem('latestGameTimestamp');
            
            // Logic to force re-registration when a new game starts
            const isGameNew = gameState.status === 'IDLE' && (newGameTimestamp || 0);

            const goldPriceBase = gameState.currentGoldPriceBase || DEFAULT_GOLD_PRICE;
            goldPriceDisplayEl.textContent = `‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏ó‡∏≥‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏ì 1 ‡∏ö‡∏≤‡∏ó: ${goldPriceBase.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            
            // Update Admin Gold Price Input
            if (isAdmin && gameState.currentGoldPriceBase) {
                goldPriceBaseInputEl.value = gameState.currentGoldPriceBase;
            }

            // NEW: Update Rewards Visibility Radio Button UI
            if (isAdmin) {
                const isShowing = gameState.showRewards !== false; 
                radioShowRewardsEl.checked = isShowing;
                radioHideRewardsEl.checked = !isShowing;
            }

            // Player/Guest re-registration check
            if (isPlayer || isGuest) {
                if (isGameNew) {
                    if (latestGameTimestamp && latestGameTimestamp !== String(newGameTimestamp)) {
                        console.log("Game reset detected. Forcing re-registration.");
                        sessionStorage.removeItem('currentUserRole');
                        sessionStorage.removeItem('playerName');
                        sessionStorage.removeItem('latestGameTimestamp');
                        updateUserRole('Unknown');
                        showPage('landing');
                        return;
                    }
                    // For the first time accessing a game in IDLE state, save the timestamp
                    sessionStorage.setItem('latestGameTimestamp', String(newGameTimestamp));
                }
            }
            
            // NEW: Control the name change button on the landing page based on game status
            if (changePlayerNameButtonEl) {
                const isGameRunningOrPaused = gameState.status === 'RUNNING' || gameState.status === 'PAUSED';
                changePlayerNameButtonEl.disabled = isGameRunningOrPaused;
                changePlayerNameButtonEl.textContent = isGameRunningOrPaused ? 
                    '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡πÄ‡∏Å‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà)' : 
                    '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
                
                // If game is running/paused, show warning if they try to change name
                if (isGameRunningOrPaused) {
                    changePlayerNameButtonEl.classList.add('disabled:bg-gray-400');
                    changePlayerNameButtonEl.classList.remove('bg-red-400', 'hover:bg-red-500');
                } else {
                    changePlayerNameButtonEl.classList.remove('disabled:bg-gray-400');
                    changePlayerNameButtonEl.classList.add('bg-red-400', 'hover:bg-red-500');
                }
            }
            
            updateAdminControls(gameState.status);

            // Update Status Text
            statusTextEl.textContent = gameState.status === 'RUNNING' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô!' :
                                     gameState.status === 'PAUSED' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß' :
                                     '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏à‡∏ö‡πÄ‡∏Å‡∏° / ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°';
            statusTextEl.className = `text-center p-3 rounded-lg font-bold text-lg ${
                gameState.status === 'RUNNING' ? 'bg-red-100 text-red-600' :
                gameState.status === 'PAUSED' ? 'bg-yellow-100 text-yellow-600' :
                'bg-gray-100 text-gray-600'
            }`;

            // Timer Logic
            if (gameState.status === 'RUNNING' && gameState.endTime) {
                timerDisplayEl.classList.remove('hidden');
                timerValueEl.classList.remove('hidden'); // FIX: Ensure timer value is visible
                timerInterval = setInterval(() => {
                    let timeRemaining = Math.max(0, Math.floor(((gameState.endTime.toMillis ? gameState.endTime.toMillis() : new Date(gameState.endTime).getTime()) - Date.now()) / 1000));
                    timerValueEl.textContent = formatTime(timeRemaining);
                    if (timeRemaining <= 0) {
                        clearInterval(timerInterval);
                        terminateGame(); // Terminate if time runs out
                    }
                }, 1000);
            } else if (gameState.status === 'PAUSED' && gameState.remainingTimeSeconds !== undefined) {
                timerDisplayEl.classList.remove('hidden');
                timerValueEl.classList.remove('hidden'); // FIX: Ensure timer value is visible
                timerValueEl.textContent = formatTime(gameState.remainingTimeSeconds);
            } else if (gameState.status === 'IDLE') {
                timerDisplayEl.classList.remove('hidden');
                timerValueEl.classList.add('hidden'); // Hide time value when IDLE
            }
        }
        
        // --- Admin Actions ---

        // NEW: Reward Visibility Radio Group Confirmation Listener
        confirmRewardsVisibilityBtnEl.addEventListener('click', async () => {
            if (!db || !userId || !isAdmin) return;

            const isShowing = radioShowRewardsEl.checked;
            
            confirmRewardsVisibilityBtnEl.disabled = true;
            rewardsUpdateMessageEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            rewardsUpdateMessageEl.classList.remove('text-red-500', 'text-green-600');
            
            try {
                // Set the showRewards state based on radio selection
                await setDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                    showRewards: isShowing,
                    currentGoldPriceBase: parseInt(goldPriceBaseInputEl.value) || DEFAULT_GOLD_PRICE 
                }, { merge: true });
                
                rewardsUpdateMessageEl.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                rewardsUpdateMessageEl.classList.add('text-green-600');
            } catch (error) {
                console.error("Error updating showRewards state: ", error);
                rewardsUpdateMessageEl.textContent = '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message;
                rewardsUpdateMessageEl.classList.add('text-red-500');
            } finally {
                confirmRewardsVisibilityBtnEl.disabled = false;
                setTimeout(() => rewardsUpdateMessageEl.textContent = '', 5000);
            }
        });
        
        mainControlButtonEl.addEventListener('click', async () => {
            if (!db || !userId || !isAdmin) return;
            
            if (gameState.status === 'IDLE') {
                await startGame();
            } else if (gameState.status === 'RUNNING') {
                await togglePause(true); // Pause
            } else if (gameState.status === 'PAUSED') {
                await togglePause(false); // Resume
            }
        });

        async function startGame() {
            if (!db || !userId || !isAdmin) return;
            mainControlButtonEl.disabled = true;
            mainControlButtonEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            
            const newPriceBase = parseInt(goldPriceBaseInputEl.value) || DEFAULT_GOLD_PRICE;

            try {
                // 1. Clear previous votes and trigger player re-registration
                await clearPlayerGameData();
                
                mainControlButtonEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...';

                // 2. Set new game state
                const startTime = Date.now();
                const endTime = new Date(startTime + (1000 * DEFAULT_DURATION_SECONDS));
                
                await setDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                    status: 'RUNNING',
                    endTime: endTime,
                    remainingTimeSeconds: DEFAULT_DURATION_SECONDS,
                    newGameTimestamp: serverTimestamp(),
                    adminId: userId,
                    currentGoldPriceBase: newPriceBase,
                    showRewards: radioShowRewardsEl.checked // Read current UI state
                });
            } catch (error) {
                console.error("Error starting game: ", error);
                showAlert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ: " + error.message);
            }
        }

        async function togglePause(isPausing) {
            if (!db || !userId || !isAdmin) return;

            if (isPausing) {
                // Calculate remaining time before pausing
                const timeRemaining = Math.max(0, Math.floor(((gameState.endTime.toMillis()) - Date.now()) / 1000));
                await updateDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                    status: 'PAUSED',
                    remainingTimeSeconds: timeRemaining,
                    endTime: null
                });
            } else {
                // Resume game
                const startTime = Date.now();
                const endTime = new Date(startTime + (1000 * gameState.remainingTimeSeconds));
                await updateDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                    status: 'RUNNING',
                    endTime: endTime
                });
            }
        }

        terminateButtonEl.addEventListener('click', async () => {
            if (!db || !userId || !isAdmin) return;
            await terminateGame();
        });

        async function terminateGame() {
            if (!db || !userId || !isAdmin) return;
            clearInterval(timerInterval);
            await setDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                status: 'IDLE',
                endTime: null,
                remainingTimeSeconds: DEFAULT_DURATION_SECONDS,
                activeAdminId: null
            }, { merge: true });
        }

        timePlusBtnEl.addEventListener('click', () => adjustTime(TIME_ADJUST_SECONDS));
        timeMinusBtnEl.addEventListener('click', () => adjustTime(-TIME_ADJUST_SECONDS));

        async function adjustTime(seconds) {
            if (!db || !userId || !isAdmin || gameState.status === 'IDLE') return;

            const gameStateRef = doc(db, GAME_STATE_DOC_PATH, 'current');

            if (gameState.status === 'RUNNING') {
                const currentEndTimeMs = gameState.endTime.toMillis();
                const newEndTimeMs = currentEndTimeMs + (1000 * seconds);

                if (newEndTimeMs <= Date.now() && seconds < 0) {
                    await terminateGame(); // End game if time runs out
                    return;
                }
                await updateDoc(gameStateRef, { endTime: new Date(newEndTimeMs) });

            } else if (gameState.status === 'PAUSED') {
                const newTimeRemaining = Math.max(0, gameState.remainingTimeSeconds + seconds);
                
                if (newTimeRemaining <= 0) {
                    await terminateGame(); // End game if time runs out
                    return;
                }
                await updateDoc(gameStateRef, { remainingTimeSeconds: newTimeRemaining });
            }
        }
        
        async function clearPlayerGameData() {
            // 1. Clear all documents in the 'votes' collection
            const votesCollection = collection(db, VOTES_COLLECTION_PATH);
            const snapshot = await getDocs(votesCollection);
            const deletePromises = [];
            snapshot.forEach(docSnap => {
                deletePromises.push(deleteDoc(docSnap.ref));
            });
            await Promise.all(deletePromises);

            // 2. Update newGameTimestamp to trigger player re-registration on clients
            await updateDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), { newGameTimestamp: serverTimestamp() });
        }

        // --- Player Actions ---

        window.selectGroup = async function(groupIndex, groupLabel) {
            if (!isPlayer || gameState.status !== 'RUNNING') {
                return showAlert(gameState.status === 'IDLE' ? '‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°' : '‡πÄ‡∏Å‡∏°‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß');
            }
            if (!userId) {
                return voteMessageEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö... ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 
                    voteMessageEl.classList.remove('hidden', 'text-green-600'), 
                    voteMessageEl.classList.add('text-red-600'), 
                    false;
            }

            voteMessageEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...';
            voteMessageEl.classList.remove('hidden', 'text-green-600', 'text-red-600');
            
            try {
                await setDoc(doc(db, VOTES_COLLECTION_PATH, userId), {
                    name: playerName,
                    vote: groupIndex,
                    timestamp: serverTimestamp(),
                    userId: userId
                }, { merge: true });

                playClickSound();
                voteMessageEl.textContent = `‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° ${groupLabel} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà`;
                voteMessageEl.classList.add('text-green-600');
            } catch (error) {
                console.error("Error submitting vote: ", error);
                voteMessageEl.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message;
                voteMessageEl.classList.add('text-red-600');
            }
        };


        // --- Render Results ---

        function renderResultsAndAdminList(totalPlayers, groupedVotes, playerVoteIndex) {
            voterCountHeaderEl.textContent = totalPlayers;
            resultsContainerEl.innerHTML = '';
            
            // Should display names and detailed info if game is IDLE (finished) OR if the user is Admin
            const showNamesAndDetails = gameState.status === 'IDLE' || isAdmin;
            // Determine if rewards should be shown based on state
            const showRewards = gameState.showRewards !== false; 
            
            // 1. Prepare data structure
            let groupData = Object.keys(groupedVotes).map(index => ({
                number: parseInt(index),
                count: groupedVotes[index].length,
                names: groupedVotes[index],
                label: GROUP_LABELS[parseInt(index)]
            }));

            // 2. Update Admin Player List (Unobtrusive)
            if (isAdmin) {
                const uniquePlayers = groupData.flatMap(g => g.names).filter((name, index, self) => self.indexOf(name) === index).sort((a, b) => a.localeCompare(b));
                adminTotalPlayersEl.textContent = uniquePlayers.length;
                adminPlayerListEl.innerHTML = uniquePlayers.map(name => `<p class="text-sm text-gray-800 border-b border-gray-100 py-1 px-1">${name}</p>`).join('') || '<p class="text-sm italic text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>';
            }

            // 3. Calculate Rewards (Complex Logic)
            let minCount = Infinity;
            groupData.forEach(g => {
                if (g.count > 0 && g.count < minCount) {
                    minCount = g.count;
                }
            });
            const minCountIfAny = minCount === Infinity ? 0 : minCount;

            let countOfMinGroups = 0;
            if (minCountIfAny > 0) {
                groupData.forEach(g => {
                    if (g.count === minCountIfAny) {
                        countOfMinGroups++;
                    }
                });
            }
            const isSingleMinimumGroup = minCountIfAny > 0 && countOfMinGroups === 1;
            const goldPriceBase = gameState.currentGoldPriceBase || DEFAULT_GOLD_PRICE;

            groupData.forEach(group => { // Start of group loop
                let goldRewardUnit = 0;
                
                if (group.count > 0) {
                    if (group.count === minCountIfAny && isSingleMinimumGroup) {
                        goldRewardUnit = 1; // 1 ‡∏ö‡∏≤‡∏ó (Golden Opportunity - Single Minimum)
                    } else if (group.count % 2 === 0) {
                        goldRewardUnit = 0.50; // 50 ‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå (Even Count)
                    } else {
                        goldRewardUnit = 0.25; // 25 ‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå (Odd Count)
                    }
                }
                
                group.goldRewardUnit = goldRewardUnit;
                const monetaryTotalReward = goldRewardUnit * goldPriceBase;
                group.monetaryTotalReward = monetaryTotalReward;
                group.monetaryAverageReward = group.count > 0 ? monetaryTotalReward / group.count : 0;
            });


            // 4. Render Groups
            groupData.forEach(group => {
                const percentage = totalPlayers > 0 ? (group.count / totalPlayers) * 100 : 0;
                const isPlayerInGroup = group.number === playerVoteIndex;
                
                // Base classes for a group box
                let groupClasses = 'shadow-md border-l-4 border-orange-500 transition duration-150 rounded-xl';
                let areaClasses = 'class="group-vote-area"';
                let statusContent = '';
                
                // FIX: Initialize memberListHTML before use
                let memberListHTML = ''; 
                
                // Highlight and non-interactive if player is in this group
                if (isPlayerInGroup) {
                    groupClasses = 'bg-green-100 border-green-500 shadow-lg ring-2 ring-green-300 !cursor-default !hover:bg-green-100';
                }

                // Interaction Logic (Only for Player and RUNNING state, and not in current group)
                if (isPlayer && gameState.status === 'RUNNING' && !isPlayerInGroup) {
                    areaClasses = `onclick="selectGroup(${group.number}, '${group.label}')" class="cursor-pointer hover:bg-gray-100 transition duration-150 group-vote-area"`;
                } else if (isPlayer && gameState.status === 'RUNNING' && isPlayerInGroup) {
                     // Ensure the clicked state is explicitly non-interactive when RUNNING
                    areaClasses = `class="group-vote-area cursor-default"`; 
                }

                // Player Status Message
                if (isPlayer) {
                    if (isPlayerInGroup) {
                        // Display large, prominent status (MODIFIED TO text-3xl)
                        statusContent = `<div class="mt-4 pt-4 flex justify-center"><p class="text-3xl font-extrabold text-green-700">‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ</p></div>`;
                    } else if (gameState.status === 'RUNNING') {
                        // Display click message for other groups
                        statusContent = `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-end"><p class="text-sm text-gray-500 font-semibold pt-2 text-orange-600">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</p></div>`;
                    }
                }

                // NEW: Reward Formatting with Masking
                let totalRewardWeightDisplay = formatGoldWeight(group.goldRewardUnit);
                let avgRewardMonetaryDisplay = group.monetaryAverageReward.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‡∏ö‡∏≤‡∏ó';
                
                if (!showRewards) { // Use the 'showRewards' variable correctly here
                    // Mask both zero and non-zero rewards
                    totalRewardWeightDisplay = 'xx ‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå/‡∏ö‡∏≤‡∏ó'; // Mask the weight description
                    
                    const avgRewardBase = group.monetaryAverageReward;
                    // Mask the average monetary reward
                    avgRewardMonetaryDisplay = maskMonetaryValue(avgRewardBase) + ' ‡∏ö‡∏≤‡∏ó';
                }
                
                // Member List Logic (Only display names if game is IDLE or if user is Admin)
                if (showNamesAndDetails) {
                    const memberCountText = `‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (${group.names.length} ‡∏Ñ‡∏ô):`;
                    const listContent = group.names.length > 0 ? 
                        `<ul class="list-disc list-inside mt-3 ml-4 space-y-1 text-gray-700 max-h-40 overflow-y-auto">${group.names.map(name => `<li class="text-sm">${name}</li>`).join('')}</ul>` : 
                        '<p class="text-sm italic text-gray-500 mt-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</p>';
                    
                    memberListHTML = `<div class="mt-4 pt-3 border-t border-gray-200"><h4 class="font-semibold text-gray-700">${memberCountText}</h4>${listContent}</div>`;
                }

                resultsContainerEl.innerHTML += `
                    <div ${areaClasses} class="${groupClasses} p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold text-gray-800">‡∏Å‡∏•‡∏∏‡πà‡∏° <span class="text-orange-600">${group.label}</span></h3>
                            <span class="text-4xl font-extrabold text-orange-700">${group.count}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-3">
                            <div class="bg-orange-500 h-3 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô: ${percentage.toFixed(1)}%</p>
                        
                        <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <h4 class="font-semibold text-yellow-700 mb-2">üéÅ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</h4>
                            <p class="text-base text-gray-800">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏£‡∏ß‡∏°: <span class="font-bold text-yellow-600">${totalRewardWeightDisplay}</span></p>
                            <p class="text-base text-gray-800">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏Ñ‡∏ô: <span class="font-bold text-yellow-600">${avgRewardMonetaryDisplay}</span></p>
                        </div>
                        
                        ${memberListHTML}
                        ${statusContent}
                    </div>
                `;
            });
        }

        // --- Logout Handlers ---

        function handlePlayerGuestLogout() {
            sessionStorage.removeItem('currentUserRole');
            // NOTE: playerName is intentionally KEPT in sessionStorage to allow resuming
            updateUserRole('Unknown');
            showPage('landing');
        }

        customAlertCloseBtnEl.addEventListener('click', hideAlert);

        // --- Event Listeners for Landing Page ---

        adminToggleLinkEl.addEventListener('click', () => {
            landingAdminCardEl.classList.toggle('hidden');
            // Adjust grid layout on landing page based on admin card visibility
            if (landingAdminCardEl.classList.contains('hidden')) {
                landingPageEl.classList.remove('md:grid-cols-3');
                landingPageEl.classList.add('md:grid-cols-2', 'md:max-w-xl');
            } else {
                landingPageEl.classList.add('md:grid-cols-3');
                landingPageEl.classList.remove('md:grid-cols-2', 'md:max-w-xl');
            }
        });

        adminLoginFormEl.addEventListener('submit', async (event) => {
            event.preventDefault();
            const passcode = adminPasscodeInputEl.value.trim();
            
            if (passcode === currentAdminPasscode) {
                updateUserRole('Admin');
                showPage('game');
                // Set activeAdminId in gameState to hide login form for other players
                // Also save the current gold price base and showRewards state
                await setDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), {
                    activeAdminId: userId,
                    currentGoldPriceBase: parseInt(goldPriceBaseInputEl.value) || DEFAULT_GOLD_PRICE,
                    showRewards: radioShowRewardsEl.checked
                }, { merge: true });
            } else {
                adminLoginMessageEl.textContent = '‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                adminPasscodeInputEl.value = '';
            }
        });

        playerRegistrationFormEl.addEventListener('submit', (event) => {
            event.preventDefault();
            const name = playerNameInputEl.value.trim();
            if (name) {
                sessionStorage.setItem('playerName', name);
                updateUserRole('Player', name);
                showPage('game');
                setupRealtimeListeners();
            }
        });

        resumePlayerButtonEl.addEventListener('click', () => {
            const name = sessionStorage.getItem('playerName');
            if (name) {
                updateUserRole('Player', name);
                showPage('game');
                setupRealtimeListeners();
            }
        });

        // NEW: Event listener for changing player name
        changePlayerNameButtonEl.addEventListener('click', () => {
            if (gameState.status === 'RUNNING' || gameState.status === 'PAUSED') {
                return showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏Ç‡∏ì‡∏∞‡πÄ‡∏Å‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß');
            }
            
            // Allow name change: clear stored name and reset UI to registration form
            sessionStorage.removeItem('playerName');
            playerNameInputEl.value = ''; 
            renderLandingPageUI();
        });


        resumeAsGuestButtonEl.addEventListener('click', () => {
            updateUserRole('Guest');
            showPage('game');
            setupRealtimeListeners();
        });

        guestAccessButtonEl.addEventListener('click', () => {
            updateUserRole('Guest');
            showPage('game');
            setupRealtimeListeners();
        });

        // --- Event Listeners for Game Page ---

        logoutAdminButtonEl.addEventListener('click', async () => {
            if (isAdmin) {
                // Clear activeAdminId when Admin logs out
                await setDoc(doc(db, GAME_STATE_DOC_PATH, 'current'), { activeAdminId: null }, { merge: true });
            }
            sessionStorage.removeItem('currentUserRole');
            sessionStorage.removeItem('playerName');
            updateUserRole('Unknown');
            showPage('landing');
        });

        logoutGuestButtonEl.addEventListener('click', handlePlayerGuestLogout);
        logoutPlayerButtonEl.addEventListener('click', handlePlayerGuestLogout);

        updatePasscodeBtnEl.addEventListener('click', async (event) => {
            event.preventDefault();
            if (!isAdmin || !db) return;
            
            const newPasscode = newAdminPasscodeInputEl.value.trim();
            
            if (newPasscode.length !== 4 || isNaN(parseInt(newPasscode))) {
                return passcodeUpdateMessageEl.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 
                       passcodeUpdateMessageEl.classList.add('text-red-500'), false;
            }

            updatePasscodeBtnEl.disabled = true;
            passcodeUpdateMessageEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            passcodeUpdateMessageEl.classList.remove('text-red-500', 'text-green-600');

            try {
                // Use setDoc with merge: true to ensure the document is created if it doesn't exist
                await setDoc(doc(db, ADMIN_CONFIG_DOC_PATH, 'current'), {
                    passcode: newPasscode,
                    lastUpdatedBy: userId,
                    timestamp: serverTimestamp()
                }, { merge: true });
                
                passcodeUpdateMessageEl.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                passcodeUpdateMessageEl.classList.add('text-green-600');
                newAdminPasscodeInputEl.value = '';
            } catch (error) {
                console.error("Error updating passcode: ", error);
                passcodeUpdateMessageEl.textContent = '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message;
                passcodeUpdateMessageEl.classList.add('text-red-500');
            } finally {
                updatePasscodeBtnEl.disabled = false;
                setTimeout(() => passcodeUpdateMessageEl.textContent = '', 5000);
            }
        });
    </script>

</body>
</html>